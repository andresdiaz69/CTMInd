# Stored Procedure: sp_rhh_liq001130_31012020

## Usa los objetos:
- [[fn_gen_DP]]
- [[fn_rhh_ausent01]]
- [[fn_rhh_DiaVacRanT]]
- [[fn_rhh_SalAntFlex]]
- [[fn_rhh_SueldoFch]]
- [[fn_rhh_ValNovFija]]
- [[fn_rhh_VG]]
- [[RHH_BASESLIQPRES]]
- [[rhh_cargos]]
- [[rhh_Consvaca]]
- [[rhh_hisdiasvac]]
- [[rhh_hisvac]]
- [[rhh_liqhis]]
- [[rhh_pagvaca]]
- [[Rhh_TbClasAus]]
- [[Rhh_Tbtipaus]]
- [[rhh_TipCon]]
- [[rhh_tipoliq]]
- [[sp_gen_dp]]
- [[sp_rhh_LiqConsVarPub]]
- [[Sp_rhh_LiqCte]]
- [[sp_rhh_liqhi04]]
- [[sp_rhh_SueldoFch]]
- [[v_rhh_concep]]

```sql
CREATE PROCEDURE [dbo].[sp_rhh_liq001130]
	@cCod_emp        CHAR(12),
	@nCodCont        INT,
	@nHabDis         MONEY,
	@nNhaDis         MONEY,
	@nDiaVac         MONEY,
	@cConcepto       CHAR(6),
	@fFec_liq        DATETIME,
	@fFec_cte        DATETIME,
	@cTip_liq        CHAR(2),
	@nInd_SVar       INT,
	@dFEC_HIS        DATETIME, /* Trae el campo  "fecha del pago"  que se escribe en el formulario de novedades de vacaciones */
	@IndLiq          BIT,
	@diatra          MONEY,
	@nNum_Pas        TINYINT       = 0,
	@nIndConsolidado BIT           = 0,
	@nInd_Prov       BIT           = 0, /*1 para provision y 0 para concepto*/
	@cIndicador      VARCHAR(15)   = '',
	@nPorcentaje     FLOAT         = 0,
	@CodConBase      VARCHAR(6)    = '',
	@cCodConProv     VARCHAR(6)    = '002970',
	@cCodConProvAcu  VARCHAR(6)    = '008401',
	@cCodConAju      VARCHAR(6)    = '008402',
	@cCodConVacPag   VARCHAR(6)    = '008403',
	@nDiaPerCau      NUMERIC(6, 2)  = 0, /*Dias totales trabajados*/
	@nIndRetBase     BIT           = 0, /* Para indicar si solo se retorna la Base, no realiza Insert en tablas */
	@nBase           MONEY         = 0 OUTPUT, /* Base Calculada para pago de la prestacion */
	@nIndSeguim      BIT           = 0 /*Mostrar los mensajes para revisión - sp_rhh_liqhi04*/
--WITH ENCRYPTION
AS
BEGIN
    SET NOCOUNT ON;
    SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

    SET DATEFIRST 1;

    IF @cConcepto IN('000050', '000051')
    BEGIN
	   RETURN;
    END;

    /*El parámetro diatra solo se debe enviar <>0 si es liquidaci¢n de contrato*/
    DECLARE @nValor MONEY;
    DECLARE @cAno CHAR(4);
    DECLARE @cPer CHAR(2);
    DECLARE @bSTrans MONEY;
    DECLARE @nSueldo MONEY;
    DECLARE @nSuelVar MONEY;
    DECLARE @fec_ing DATETIME;		/* FECHA DE INGRESO DEL EMPLEADO */
    DECLARE @diasIng MONEY;	  		/* dias desde el ingreso del empleado */
    DECLARE @FECTMP DATETIME;
    DECLARE @FecIni DATETIME;		/* fecha de corte menos un a¤o si los dias del primes mes */
    DECLARE @dia31 SMALLINT;		/*Para controlar el pago del dia 31   */
    DECLARE @fec_sal DATETIME;
    DECLARE @fec_ent DATETIME;
    DECLARE @nMes SMALLINT;
    DECLARE @ModLiq CHAR(2);
    DECLARE @nLiqVac BIT;
    DECLARE @nCantidad MONEY;
    DECLARE @cCod_cia CHAR(3),
		  @cCod_suc CHAR(3),
		  @cCod_cco CHAR(10),
		  @cCod_cl1 CHAR(12),
		  @cCod_cl2 CHAR(12),
		  @cCod_cl3 CHAR(12),
		  @cCod_cl4 VARCHAR(12),
		  @cCod_cl5 VARCHAR(12),
		  @cCod_cl6 VARCHAR(12),
		  @cCod_cl7 VARCHAR(12),
		  @tip_con  CHAR(2);
    DECLARE @nSalBas MONEY;
    DECLARE @nIndDesc31 TINYINT;
    DECLARE @Sal_AntFlex MONEY;
    DECLARE @ValNovFij MONEY;
    DECLARE @nIndPdias TINYINT;
    DECLARE @Ind_VacSalVar TINYINT;
    DECLARE @proy_sal NUMERIC(6, 2);		/* Porcentaje de proyeccion salarial */
    DECLARE @Ind_VacSalVarLC BIT;
    DECLARE @fec_ret DATETIME;
    DECLARE @nind_SueldoSvar TINYINT;
    DECLARE @cod_conv VARCHAR(15);
    DECLARE @cSubCad NVARCHAR(MAX);
    DECLARE @cMsgErr NVARCHAR(MAX);
    DECLARE @nNovFija MONEY;
    DECLARE @nPropBasesCalcPrest BIT;    /*vg(135) Empleado trabajo menos de 30 días, proporcionar Bases para Calculo de Prestaciones? */
    DECLARE @IDL_NUM BIGINT;
    DECLARE @nSalMin MONEY;
    DECLARE @nom_con VARCHAR(200);
    DECLARE @nReg_sal SMALLINT;
    DECLARE @cNomCon VARCHAR(100);
    DECLARE @cod_car CHAR(8);
    DECLARE @cNomCar VARCHAR(250);
    DECLARE @aux_tra TINYINT;
    DECLARE @pro_vac SMALLINT;
    DECLARE @MESH CHAR(2);
    DECLARE @ANOH CHAR(4);
    DECLARE @apl_con SMALLINT; /*Aplicación del concepto*/
    DECLARE @apl_cont SMALLINT; /*Aplicación del concepto transporte*/
    DECLARE @Dias_aus MONEY;
    DECLARE @Dias_aus1 MONEY;
    DECLARE @SQLString NVARCHAR(1000);
    DECLARE @ParmDefinition NVARCHAR(500);
    DECLARE @pro_sub SMALLINT;       /* Aplicar promedio Sub. transporte  */
    DECLARE @nVlrSub MONEY;
    DECLARE @nSubTransP MONEY;
    DECLARE @nResult1 MONEY;
    DECLARE @nResult2 MONEY;
    DECLARE @Subtra2 BIT;
    DECLARE @Subtra1 BIT;
    DECLARE @cod_tlq SMALLINT;
    DECLARE @nResultado MONEY;
    DECLARE @nResulHis MONEY;	/*El valor del concepto en la primera quincena*/
    DECLARE @nBaseProvHis MONEY;
    DECLARE @nBaseProv MONEY;
    DECLARE @diaVinc INT;
    DECLARE @diaVinc1 INT;
    DECLARE @IndProv BIT;
    DECLARE @nCeroTrns BIT;
    DECLARE @nCeroTrns1 BIT;
    DECLARE @nCeroTrns2 BIT;
    DECLARE @ProvBase1 CHAR(1);

    --DECLARE @nBase		MONEY;
    DECLARE @Base_Fin_PreNom BIT = 0;
    DECLARE @Base_Fin_PerLiq_Hist BIT = 0;
    DECLARE @Base_Fin_Mes_Hist BIT = 0;
    DECLARE @SrioMesesVari TINYINT = 0;
    DECLARE @SrioHisLab BIT = 0;
    DECLARE @SrioProm BIT = 0;
    DECLARE @SrioPromMes_a_Mes BIT = 0;
    DECLARE @nValorTot MONEY = 0; /*Sumatoria total del valor de los conceptos base*/
    DECLARE @nBaseDia MONEY = 0; /*Número de días que componen la base*/
    DECLARE @nCanBase MONEY = 0; /*Sumatoria total de la cantidad de los conceptos base*/
    DECLARE @nBasePromMes MONEY = 0; /*Promedio mensual @nValorTot/@nBaseDia * 30 */
    DECLARE @nBasePorUnidad MONEY = 0; /*Base Unitaria @nValorTot/@nCanBase */
    DECLARE @indicador VARCHAR(8);
    DECLARE @vg139 BIT;
    DECLARE @vg140 BIT;
    DECLARE @vg147 BIT;
    DECLARE @vg138 BIT;
    DECLARE @nValProvis MONEY;
    DECLARE @nValPag MONEY;
    DECLARE @DiaVacPag BIGINT;
    DECLARE @nValVac MONEY;
    DECLARE @nValAjusAnte MONEY;
    DECLARE @nValDife MONEY;
    DECLARE @nDiaCau SMALLINT;
    DECLARE @nDiaAus SMALLINT;
    DECLARE @nDiaPerAcum NUMERIC(6, 2);
    DECLARE @diasvac_consol NUMERIC(6, 2); /*Dias Vaaciones para Consolidado*/
    DECLARE @dias_vac NUMERIC(6, 2); /*Dias Vacaciones para Consolidado*/
    DECLARE @dias_Pen NUMERIC(6, 2); /*Dias Vacaciones para Consolidado*/
    DECLARE @Prov_SueldoSvar BIT = 0;
    DECLARE @dia_vac NUMERIC;
    DECLARE @FecFin DATETIME;
    DECLARE @nB03Fij MONEY;
    DECLARE @nB04Fij MONEY;
    DECLARE @nB05Fij MONEY;
    DECLARE @nB06Fij MONEY;
    DECLARE @nB07Fij MONEY;
    DECLARE @nB08Fij MONEY;
    DECLARE @nB09Fij MONEY;
    DECLARE @nB10Fij MONEY;
    DECLARE @nB11Fij MONEY;
    DECLARE @nB12Fij MONEY;
    DECLARE @nB13Fij MONEY;
    DECLARE @nB14Fij MONEY;
    DECLARE @nB15Fij MONEY;
    DECLARE @nB16Fij MONEY;
    DECLARE @nB17Fij MONEY;
    DECLARE @nB18Fij MONEY;
    DECLARE @nB19Fij MONEY;
    DECLARE @nB20Fij MONEY;
    DECLARE @ModConcep CHAR(2);
    DECLARE @ind_sab BIT;
    DECLARE @val_dianhab MONEY;
    DECLARE @val_diahab MONEY;
    DECLARE @nIndInclRetro BIT = 1;
    DECLARE @fec_vac DATETIME;
    DECLARE @nValBase02 MONEY;

    SET @diasIng = 0;
    SET @diaVinc = 0;
    SET @diaVinc1 = 0;
    SET @dia_vac = 0;
    SET @Dias_aus1 = 0;
    SET @Dias_aus = 0;
    SET @Sal_AntFlex = 0;
    SET @nValBase02 = 0;
    SET @val_diahab = 0;
    SET @val_dianhab = 0;

    SET @nSalMin = CONVERT(MONEY, dbo.fn_rhh_VG( 60, @dFEC_HIS ));
    SET @nVlrSub = CONVERT(MONEY, dbo.fn_rhh_VG( 61, @fFec_cte ));

    SET @vg139 = CONVERT(BIT, dbo.fn_rhh_VG( 139, NULL ));
    SET @vg140 = CONVERT(BIT, dbo.fn_rhh_VG( 140, NULL ));

    EXEC sp_rhh_LiqConsVarPub 'fFec_Fin_HL',
						@cSubCad OUTPUT,
						@cMsgErr OUTPUT;

    SELECT @fec_vac = fec_vac
    FROM rhh_hisvac
    WHERE cod_emp = @cCod_emp AND fec_his = @dfec_his;

    SELECT @fec_sal = fec_sal,
		 @fec_ent = fec_ent
    FROM rhh_hisvac
    WHERE cod_emp = @cCod_emp AND fec_vac = @fec_vac;

    IF @nIndRetBase = 1
    BEGIN
	   SET @fec_sal = @fFec_cte;
	   SET @fec_ent = @fFec_cte;
    END;

    /*	Se determina si se debe incluir el retroactivo en el cálculo del salario*/
    IF @cTip_liq = '16' AND @nNum_Pas = 1
    BEGIN
	   SET @nIndInclRetro = 0;
    END;

    IF @cMsgErr IS NULL
    BEGIN
	   SET @fec_ret = REPLACE(@cSubCad, '''', '');

	   IF @fec_ret < @dFEC_HIS
	   BEGIN
		  SELECT @dFEC_HIS = @fec_ret;
	   END;
    END;

    SELECT @cCod_cia = cod_cia,
		 @cCod_suc = cod_suc,
		 @cCod_cco = cod_cco,
		 @cCod_cl1 = cod_cl1,
		 @cCod_cl2 = cod_cl2,
		 @cCod_cl3 = cod_cl3,
		 @cCod_cl4 = cod_cl4,
		 @cCod_cl5 = cod_cl5,
		 @cCod_cl6 = cod_cl6,
		 @cCod_cl7 = cod_cl7,
		 @tip_con = tip_con,
		 @nSalBas = dbo.fn_rhh_SueldoFch( @cCod_emp, @fFec_cte, @nIndInclRetro, 0 ), --sal_bas,
		 @ModLiq = mod_liq,
		 @nIndPdias = ind_pdias,
		 @cod_conv = cod_conv,
		 @dia31 = ind_m31,
		 @fec_ing = fec_ing,
		 @IDL_num = IDL_num,
		 @nReg_sal = reg_sal,
		 @cod_car = cod_car,
		 @cod_tlq = cod_tlq,
		 @dia_vac = dia_vac,
		 @ind_sab = ind_sab
    FROM #T_rhh_emplea
    WHERE cod_emp = @cCod_emp AND cod_cont = @nCodCont;

    SET @dia_vac = ISNULL(@dia_vac, 0);

    SELECT @nLiqVac = Liq_Vac,
		 @Ind_VacSalVar = Ind_VacSalVar,
		 @Ind_VacSalVarLC = Ind_VacSalVarLC,
		 @nind_SueldoSvar = ind_SueldoSvar,
		 @cNomCon = nom_con,
		 @aux_tra = aux_tra,
		 @pro_vac = pro_vac,
		 @pro_sub = trn_vac,
		 @Prov_SueldoSvar = Prov_SueldoSvar
    FROM rhh_TipCon
    WHERE tip_con = @tip_con;
	
    IF @nLiqVac = 0
    BEGIN
	   EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cConcepto,
						 @Cantidad = 0,
						 @Resultado = 0;

	   RETURN(0);
    END;

    /* para revisar los valores que llegan como parametros   */
    IF(@dFEC_HIS = '19000101' AND @nInd_Prov = 0
	 )  /* No tiene registro de vacaciones para liquidar   */
    BEGIN
	   EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cConcepto,
						 @Cantidad = 0,
						 @Resultado = 0;

	   RETURN(0);
    END;

    SET @cAno = CONVERT(CHAR(4), YEAR(@fFec_cte));
    SET @cPer = RIGHT('00' + RTRIM(CONVERT(CHAR(2), MONTH(@fFec_cte))), 2);

    CREATE TABLE #cConcepND(
	    cod_con CHAR(6) COLLATE database_default
					  );

    SELECT @apl_con = apl_con,
		 @nom_con = nom_con
    FROM #T_Rhh_ConcepEmp
    WHERE cod_con = @cConcepto;

    SET @ProvBase1 = 0;

    IF @nind_SueldoSvar = 1 AND @Prov_SueldoSvar = 1
    BEGIN
	   SET @ProvBase1 = 1;
    END;

    IF @nind_SueldoSvar = 1
    BEGIN
	   INSERT INTO #cConcepND
	   SELECT DISTINCT
			cod_con
	   FROM v_rhh_concep
	   WHERE cod_bas = '01';
    END;

    IF @nInd_Prov = 1
    BEGIN
	   /***** INICIO CALCULO PROVISIONES*/
	   SET @nResult2 = 0;

	   IF( SELECT dias_tlq
		  FROM rhh_tipoliq
		  WHERE cod_tlq = @cod_tlq ) = 15
	   BEGIN
		  SET @cod_tlq = 1;
	   END;

	   DECLARE @cCriterio VARCHAR(50);
	   DECLARE @nValBase1Prov MONEY;

	   SET @MESH = RIGHT('00' + RTRIM(CONVERT(CHAR(2), @cPer)), 2);
	   SET @ANOH = CONVERT(CHAR(4), @cAno);

	   SELECT @apl_cont = apl_con
	   FROM #T_Rhh_ConcepEmp AS D
	   WHERE cod_con = '001300';

	   CREATE TABLE #cConcepAus(
		   cod_con CHAR(6) COLLATE database_default
						  );

	   INSERT INTO #cConcepAus
	   SELECT DISTINCT
			cod_con
	   FROM Rhh_Tbtipaus AS TA
	   INNER JOIN Rhh_TbClasAus AS CA ON TA.cla_aus = CA.cla_aus
	   WHERE ind_DiaAus = 1;

	   IF @apl_con >= 2 OR @apl_cont = 2
	   BEGIN
		  SELECT @Dias_aus1 = ISNULL(SUM(can_liq), 0)
		  FROM #T_Rhh_liqhis
		  INNER JOIN #cConcepAus ON #T_Rhh_LiqHis.cod_con = #cConcepAus.cod_con
		  WHERE cod_cont = @nCodCont
			   AND YEAR(fec_cte) = @ANOH
			   AND MONTH(fec_cte) = @MESH
			   AND fec_cte < @fFec_cte
			   AND num_pas <> 3; --Esta condición elimina lols registros Delta de retroactivo mes a mes;
		  SELECT @Dias_aus1 = ISNULL(SUM(can_liq), 0)
		  FROM #T_Rhh_liqhis
		  WHERE cod_cont = @nCodCont
			   AND YEAR(fec_cte) = @ANOH
			   AND MONTH(fec_cte) = @MESH
			   AND cod_con = '000005'
			   AND fec_cte < @fFec_cte
			   AND num_pas <> 3; --Esta condición elimina lols registros Delta de retroactivo mes a mes;
		  SELECT @diaVinc1 = ISNULL(SUM(can_liq), 0)
		  FROM #T_Rhh_LiqHis
		  WHERE cod_cont = @nCodCont
			   AND cod_con = '000001'
			   AND YEAR(fec_cte) = @ANOH
			   AND MONTH(fec_cte) = @MESH
			   AND fec_cte < @fFec_cte
			   AND tip_liq = '01'
			   AND num_pas <> 3; --Esta condición elimina lols registros Delta de retroactivo mes a mes;
	   END;

	   IF @apl_con <> 2
	   BEGIN
		  SELECT @Dias_aus = ISNULL(SUM(dia_vac + ausencia - CASE
													  WHEN @nIndPdias = 1 THEN d31_trab
													  ELSE 0
												   END), 0),
			    @diaVinc = SUM(dias)
		  FROM #t_rhh_hislab;
	   END;

	   SET @nValBase1Prov = 0;
	   SET @cCriterio = ' AND cod_bas<>''01''';

/** Si el indicador en el tipo de contrato para Cesantias tiene parametrizado el Auxilio de transporte
		  como valor mensual, se cálcula el valor correspondiente al periodo de acuerdo al tipo de aplicación
		  del concepto de subsidio de transporte **/
	   --IF @pro_sub = 2  AND @aux_tra <>1 AND EXISTS (SELECT cod_con FROM #t_resultado WHERE cod_con='001300') -- 20121230 Solo si en la liquidacion que se esta procesando se liquida el concepto 001300
	   select '@pro_sub'=@pro_sub, @aux_tra
	   IF @pro_sub = 2 AND @aux_tra <> 1  -- Paquete 51 Se elimina esta condicion. Se respeta parametrizacion del contrato
	   BEGIN
		  IF @nInd_SVar = 0
		  BEGIN
			 IF @nSalBas <= (2 * @nSalMin)
			 BEGIN
				SELECT @nSubTransP = @nVlrSub;
			 END;
				ELSE
			 BEGIN
				SELECT @nSubTransP = 0;
			 END;
		  END;
	   END;
		  ELSE
	   BEGIN
		  SELECT @nSubTransP = 0;
	   END;
	   
	   IF NOT EXISTS( SELECT cod_con
				   FROM #t_Rhh_ConcepLiqEmp
				   WHERE cod_con = '001300' )
	   BEGIN
		  SET @nSubTransP = 0;
	   END;

	   SET @SQLString = 'SELECT @Resultado = SUM(val_liq * CASE WHEN nat_liq = 1 THEN 1 WHEN nat_liq = 2 THEN -1 ELSE 1 END ' + CHAR(13);
	   SET @SQLString = @SQLString + '			  +	 CASE ' + CHAR(13);
	   SET @SQLString = @SQLString + '					WHEN H.cod_con = ''001300'' AND ' + RTRIM(CONVERT(CHAR, @pro_sub)) + ' = 2' + CHAR(13);
	   SET @SQLString = @SQLString + '						   AND ' + RTRIM(CONVERT(CHAR, @Dias_aus1)) + ' > 0 AND can_liq > 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '					    THEN ROUND(val_liq /can_liq  * ' + RTRIM(CONVERT(CHAR, @Dias_aus1)) + ', 0)' + CHAR(
	   13);
	   SET @SQLString = @SQLString + '					ELSE 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '				 END ), ' + CHAR(13);
	   SET @SQLString = @SQLString + '@CeroTrns = MAX(CASE ' + CHAR(13);
	   SET @SQLString = @SQLString + '				 WHEN H.cod_con = ''001300'' AND ' + RTRIM(CONVERT(CHAR, @Dias_aus1)) + ' > 0 THEN 1 ' + CHAR(
	   13);
	   SET @SQLString = @SQLString + '				 ELSE 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '			  END), ' + CHAR(13);
	   SET @SQLString = @SQLString + '@Subtra   = SUM(VAL_LIQ *(CASE  WHEN H.cod_con =''001300'' THEN 1 ELSE 0 End))' + CHAR(13);
	   SET @SQLString = @SQLString + 'FROM #T_Rhh_liqhis H ' + CHAR(13);
	   SET @SQLString = @SQLString + 'INNER JOIN #T_Rhh_ConcepEmp C ON H.cod_con = C.cod_con' + CHAR(13);
	   SET @SQLString = @SQLString + 'WHERE H.' + RTRIM(@cIndicador) + ' = 1 ' + CHAR(13);
	   SET @SQLString = @SQLString + '	    AND cod_cont = ' + CHAR(39) + RTRIM(@nCodCont) + CHAR(39) + CHAR(13);
	   SET @SQLString = @SQLString + '	    AND YEAR(fec_cte) = ' + CHAR(39) + @ANOH + CHAR(39) + CHAR(13);
	   SET @SQLString = @SQLString + '	    AND MONTH(fec_cte) = ' + CHAR(39) + @MESH + CHAR(39) + CHAR(13);
	   SET @SQLString = @SQLString + CASE
								  WHEN @apl_con = 3 AND @cTip_liq <> '04' THEN '		  AND  fec_cte < ' + CHAR(39) + RTRIM(CONVERT(CHAR,
								  @fFec_cte, 112)) + CHAR(39)
							   --								/*No incluir liq 01 de la misma fecha de liq*/
								  WHEN @cTip_liq = '04' THEN --
							   '	   AND (fec_cte < ' + CHAR(39) + RTRIM(CONVERT(CHAR, @fFec_cte, 112)) + CHAR(39) + CHAR(13) + --
							   '			 AND tip_liq <> ' + CHAR(39) + @cTip_liq + CHAR(39) + ')' + CHAR(13)
							   --								/*El cpto se liquida en la segunda Quincena*/
								  WHEN @apl_con = 2 THEN--
							   '	   AND fec_cte < ' + CHAR(39) + RTRIM(CONVERT(CHAR, @fFec_cte, 112)) + CHAR(39)
								  ELSE ''
							   END;

	   SET @ParmDefinition = N'@Resultado MONEY OUTPUT, @CeroTrns BIT OUTPUT,@Subtra BIT OUTPUT';
	   SET @nCeroTrns = 0;

	   IF @ProvBase1 = 1
	   BEGIN
		  SET @SQLString = @SQLString + @cCriterio;

		  SET @nValBase1Prov = ROUND(@nSalBas / 30 * @diaVinc1, 0);
		  SET @nValBase1Prov = ISNULL(@nValBase1Prov, 0);
	   END;

	   EXECUTE sp_executesql @SQLString,
						@ParmDefinition,
						@Resultado = @nResult1 OUTPUT,
						@CeroTrns = @nCeroTrns1 OUTPUT,
						@Subtra = @Subtra1 OUTPUT;

	   SET @nResult1 = ISNULL(@nResult1, 0);
	   SET @nCeroTrns1 = ISNULL(@nCeroTrns1, 0);

	   IF @cTip_liq <> '04'
	   BEGIN
		  /*Valores En la misma fecha de corte en otro tipo de liquidacion a la de proceso */
		  SET @SQLString =
		  'SELECT @Resultado = ISNULL(SUM(val_liq * CASE
												    WHEN nat_liq = 1 THEN 1
												    WHEN nat_liq = 2 THEN-1
												    ELSE 1
												END), 0)
	   FROM #t_Rhh_liqhis
	   WHERE cod_cont = ' + CHAR(39) + RTRIM(@nCodCont) + CHAR(39) + ' AND ' + RTRIM(@cIndicador) + ' = 1
		    AND fec_Cte = ' + CHAR(39) + RTRIM(CONVERT(CHAR, @fFec_cte, 112)) + CHAR(39) + ' AND tip_liq <> ' + @cTip_liq;

		  SET @ParmDefinition = N'@Resultado MONEY OUTPUT';

		  EXECUTE sp_executesql @SQLString,
						    @ParmDefinition,
						    @Resultado = @nResult2 OUTPUT;
	   END;

	   SET @nResult1 = @nResult1 + @nValBase1Prov + @nResult2;

	   /* Validacion indicador para el concepto 001300 - subsidio de transporte*/
	   SET @SQLString = 'SELECT @Resultado = COUNT(cod_con) FROM #T_Rhh_ConcepEmp WHERE cod_con=''001300'' AND ' + RTRIM(@cIndicador) + ' = 1';

	   SET @ParmDefinition = N'@cIndicador VARCHAR(15), @Resultado MONEY OUTPUT';

	   EXECUTE sp_executesql @SQLString,
						@ParmDefinition,
						@cIndicador = @cIndicador,
						@Resultado = @nResult2 OUTPUT;

	   --IF @Subtra1 = 0 AND @nResult1 > 0 AND @nResult2 > 0
	   --BEGIN		/*2013-0940*/
	   --SET @nResult1 = @nResult1 + CASE @cod_tlq
	   --				    WHEN 1 THEN @nSubTransP / 2
	   --				    ELSE @nSubTransP
	   --				END;
	   --END;
	   SET @SQLString = 'SELECT @Resultado = SUM(b.val_liq * CASE WHEN B.nat_con = 1 THEN 1 WHEN B.nat_con = 2 THEN -1 ELSE 1 END' + CHAR(13);
	   SET @SQLString = @SQLString + '		 +	  CASE ' + CHAR(13);
	   SET @SQLString = @SQLString + '				 WHEN B.cod_con = ''001300'' AND ' + RTRIM(CONVERT(CHAR, @pro_sub)) + ' = 2  ' + CHAR(13);
	   SET @SQLString = @SQLString + '				 	    AND ' + RTRIM(CONVERT(CHAR, @Dias_aus)) + ' <> 0 AND B.can_liq > 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '					THEN ROUND(B.val_liq /B.can_liq  * ' + RTRIM(CONVERT(CHAR, @Dias_aus)) + ', 0)' + CHAR(13)
	   ;

	   SET @SQLString = @SQLString + '				 ELSE 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '			  END ), ' + CHAR(13);
	   SET @SQLString = @SQLString + '	@CeroTrns = MAX(' + CHAR(13);
	   SET @SQLString = @SQLString + '			  CASE WHEN b.cod_con = ''001300'' AND ' + RTRIM(CONVERT(CHAR, @Dias_aus)) + ' > 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '					THEN 1 ' + CHAR(13);
	   SET @SQLString = @SQLString + '				ELSE 0 ' + CHAR(13);
	   SET @SQLString = @SQLString + '			  END),' + CHAR(13);
	   SET @SQLString = @SQLString + '	@SubTra =  SUM(VAL_LIQ *(CASE  WHEN b.cod_con =''001300'' THEN 1 ELSE 0 END))' + CHAR(13);
	   SET @SQLString = @SQLString + 'FROM #t_resultado B ' + CHAR(13);
	   SET @SQLString = @SQLString + 'INNER JOIN #T_Rhh_ConcepEmp C ON B.cod_con = C.cod_con ' + CHAR(13);
	   SET @SQLString = @SQLString + 'WHERE B.' + RTRIM(@cIndicador) + ' = 1 AND val_liq <>0 ';

	   SET @ParmDefinition = N'@Resultado MONEY OUTPUT, @CeroTrns BIT OUTPUT,@Subtra BIT OUTPUT';

	   IF @ProvBase1 = 1
	   BEGIN
		  SET @SQLString = @SQLString + @cCriterio;

		  SET @nValBase1Prov = ROUND(@nSalBas / 30 * @diaVinc, 0);
		  SET @nValBase1Prov = ISNULL(@nValBase1Prov, 0);
	   END;

	   EXECUTE sp_executesql @SQLString,
						@ParmDefinition,
						@Resultado = @nResult2 OUTPUT,
						@CeroTrns = @nCeroTrns2 OUTPUT,
						@Subtra = @Subtra2 OUTPUT;

	   SET @nResult2 = ISNULL(@nResult2, 0);
	   SET @nCeroTrns2 = ISNULL(@nCeroTrns2, 0);

	   SET @nResult2 = @nResult2 + @nValBase1Prov;

	   SET @nResultado = @nResult1 + @nResult2;

	   IF @nCeroTrns1 <> 0 OR @nCeroTrns2 <> 0
	   BEGIN
		  SET @nCeroTrns = 1;
	   END;

	   IF @nCeroTrns = 1 AND @Dias_aus > 0
	   BEGIN
		  SET @Dias_aus = 0;
	   END;

	   --===========================================================================
	   SET @nResulHis = 0;

	   IF @cTip_liq <> 16
	   BEGIN
		  SELECT @nResulHis = ISNULL(SUM(val_liq), 0)
		  FROM #T_rhh_liqhis
		  WHERE cod_cont = @nCodCont
			   AND MONTH(fec_cte) = @cPer
			   AND YEAR(fec_cte) = @cAno
			   AND fec_cte < @fFec_cte
			   AND cod_con = @cConcepto;

		  SELECT @nBaseProvHis = ISNULL(SUM(val_liq), 0)
		  FROM #T_Rhh_liqhis
		  WHERE cod_cont = @nCodCont
			   AND MONTH(fec_cte) = @cPer
			   AND YEAR(fec_cte) = @cAno
			   AND fec_cte < @fFec_cte
			   AND cod_con = @CodConBase;

	   END;

	   SET @nResulHis = ISNULL(@nResulHis, 0);
	   SET @nBaseProvHis = ISNULL(@nBaseProvHis, 0);
	   SET @nBaseProv = ISNULL(@nResultado, 0) - @nBaseProvHis;
	   IF @cConcepto = @cCodConProv
	   BEGIN
		  EXEC dbo.Sp_rhh_LiqCte @cCodCon = @CodConBase,
							@Cantidad = 0,
							@Resultado = @nBaseProv;
	   END;

	   SELECT @nPorcentaje = @dia_vac * @nPorcentaje / 15;

	   SET @nResultado = ROUND((@nResultado * @nPorcentaje / 100) - @nResulHis, 0);

	   EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cConcepto,
						 @Cantidad = 0,
						 @Resultado = @nResultado;

	   RETURN(0);
	   /***** FIN CALCULO PROVISIONES*/
    END;

    --Esta tabla es la transpuesta de la tabla #T_BasesReg, no incluye cantidades
    IF OBJECT_ID('TempDb..#T_BasesCol') IS NULL
    BEGIN
	   CREATE TABLE #T_BasesCol(
		   [T_Origen] CHAR(1) COLLATE DATABASE_DEFAULT,
		   [Ind_Svar] BIT NULL,
		   [base_dia] INT NULL,
		   [dia_int]  INT NULL,
		   [b01_liq]  MONEY NULL,
		   [b02_liq]  MONEY NULL,
		   [b03_liq]  MONEY NULL,
		   [b04_liq]  MONEY NULL,
		   [b05_liq]  MONEY NULL,
		   [b06_liq]  MONEY NULL,
		   [b07_liq]  MONEY NULL,
		   [b08_liq]  MONEY NULL,
		   [b09_liq]  MONEY NULL,
		   [b10_liq]  MONEY NULL,
		   [b11_liq]  MONEY NULL,
		   [b12_liq]  MONEY NULL,
		   [b13_liq]  MONEY NULL,
		   [b14_liq]  MONEY NULL,
		   [b15_liq]  MONEY NULL,
		   [b16_liq]  MONEY NULL,
		   [b17_liq]  MONEY NULL,
		   [b18_liq]  MONEY NULL,
		   [b19_liq]  MONEY NULL,
		   [b20_liq]  MONEY NULL,
						  );
    END;

    IF(@nHabDis + @nNhadis) <> 0 OR @nIndRetBase = 1
    BEGIN
	   SET @vg147 = CONVERT(BIT, dbo.fn_rhh_VG( 147, NULL ));
	   SET @vg138 = CONVERT(BIT, dbo.fn_rhh_VG( 138, NULL ));

	   SET @nValor = 0;
	   SET @bSTrans = 0;
	   SET @nSueldo = 0;
	   SET @nSuelVar = 0;
	   SET @nIndDesc31 = 0;

	   SET @Base_Fin_PreNom = CASE
							WHEN @Ind_VacSalVar = 1 THEN 1
							ELSE 0
						 END;
	   SET @Base_Fin_PerLiq_Hist = CASE
								WHEN @Ind_VacSalVar = 2 THEN 1
								ELSE 0
							 END;
	   SET @Base_Fin_Mes_Hist = CASE
							  WHEN @Ind_VacSalVar = 3 THEN 1
							  ELSE 0
						   END;

	   IF @Ind_VacSalVarLC = 1 AND (@cTip_liq = '04' OR @cTip_liq = '14'
							 )
	   BEGIN
		  SET @Base_Fin_PreNom = 1;
		  SET @Base_Fin_PerLiq_Hist = 0;
		  SET @Base_Fin_Mes_Hist = 0;
	   END;

	   SET @SrioHisLab = 1;

	   IF @nInd_SVar = 1
	   BEGIN
		  SET @SrioProm = CASE
						  WHEN @nind_SueldoSvar = 2 THEN 1
						  ELSE 0
					   END;

		  IF @SrioProm = 1
		  BEGIN
			 SET @SrioHisLab = 0;
		  END;
	   END;

	   CREATE TABLE #NovFija(
		   cod_con CHAR(6) COLLATE database_default,
		   mod_liq CHAR(2) COLLATE database_default,
		   nat_con TINYINT,
		   val_nov MONEY,
		   cod_bas CHAR(2) COLLATE database_default
					    );

	   SET @proy_sal = CONVERT(NUMERIC(6, 2), dbo.fn_rhh_VG( 28, NULL ));
	   SET @proy_sal = ISNULL(@proy_sal, 0);

	   IF @cConcepto = '001130'
	   BEGIN
		  IF @dia31 = 0
		  BEGIN
			 SELECT @nIndDesc31 = SUM(d31_vac)
			 FROM #t_rhh_HisLab;

			 IF @nIndDesc31 = 0 /*Validacion con las fechas del registro de vacaciones, para vacaciones anticipadas */
			 BEGIN
				SELECT @nIndDesc31 = SUM(dia_31)
				FROM [dbo].[fn_rhh_DiaVacRanT]( @cCod_emp, @fec_sal, @fec_ent, @nIndPdias, @dia31 );
			 END;

			 IF @nIndDesc31 > 0
			 BEGIN
				SET @nIndDesc31 = 1;
			 END;
		  END;
	   END;

	   IF @Ind_VacSalVarLC = 1 AND @cTip_liq IN('04', '14')
	   BEGIN
		  SET @Ind_VacSalVar = 1;
	   END;

	   IF @Ind_VacSalVar = 1
	   BEGIN/**Liquidación Actual**/
		  SET @FECTMP = @fFec_cte;
	   END;

	   IF @Ind_VacSalVar = 2
	   BEGIN /** Ultima liquidación en el historico**/
		  SELECT @FECTMP = MAX(fec_cte)
		  FROM #T_Rhh_liqhis
		  WHERE cod_cont = @nCodCont AND fec_cte < @fFec_cte AND tip_liq NOT IN(
																  '14', '02'
																 );
	   END; /*2013-1038*/

	   IF @Ind_VacSalVar = 3
	   BEGIN /** Ultima liquidación en el historico del mes anterior**/
		  SELECT @FECTMP = MAX(fec_cte)
		  FROM #T_Rhh_liqhis
		  WHERE per_liq = RIGHT('00' + RTRIM(CONVERT(CHAR(2), MONTH(DATEADD(MONTH, -1, @fFec_cte)))), 2)
			   AND ano_liq = YEAR(DATEADD(MONTH, -1, @fFec_cte))
			   AND cod_cont = @nCodCont
			   AND tip_liq NOT IN(
							  '14', '02'
							 );
	   END; /*2013-1038*/

	   SET @FECTMP = ISNULL(@FECTMP, @fFec_cte);

	   SET @FecFin = @FECTMP;

	   IF @cTip_liq = '04' AND @Ind_VacSalVar = 1
	   BEGIN
		  SET @FecFin = @fec_ret;
		  SET @FecIni = DATEADD(DAY, 1, DATEADD(YEAR, -1, @FecFin));
	   END;
		  ELSE
	   BEGIN
		  SET @FecIni = DATEADD(DAY, 1, DATEADD(YEAR, -1, @FECTMP));
	   END;

	   IF DAY(@FecIni) = 29 AND MONTH(@FecIni) = 2
	   BEGIN
		  SET @FecIni = DATEADD(DAY, 1, @FecIni);
	   END;

	   IF DAY(@FecIni) = 31
	   BEGIN
		  SET @FecIni = DATEADD(DAY, 1, @FecIni);
	   END;

	   IF @fec_ing > @FecIni
	   BEGIN
		  SET @FecIni = @fec_ing;
		  EXEC sp_gen_dp @fec_ing,
					  @dFEC_HIS,
					  @diasIng OUTPUT;
	   END;

	   IF @nIndPdias = 1
	   BEGIN
		  SET @diaTRA = DATEDIFF(DAY, @FecIni, @FecFin) + 1;
	   END;
		  ELSE
	   BEGIN
		  EXEC SP_GEN_DP @FecIni,
					  @FecFin,
					  @diaTRA OUTPUT;
	   END;    /* Dias trabajados   */

	   IF @diaTRA < 360 /*2013-0768*/
	   BEGIN
		  IF @cTip_liq = '04'/*Cuando es menos de un año el promedio se calcula hasta la fecha de retiro*/
		  BEGIN
			 IF @nIndPdias = 1
			 BEGIN
				SET @diaTRA = DATEDIFF(DAY, @FecIni, @dFEC_HIS) + 1;
			 END;
				ELSE
			 BEGIN
				EXEC SP_GEN_DP @FecIni,
							@dFEC_HIS,
							@diaTRA OUTPUT;
			 END;    /* Dias trabajados   */
		  END;
			 ELSE
		  BEGIN
			 IF @nIndPdias = 1
			 BEGIN
				SET @diaTRA = DATEDIFF(DAY, @FecIni, @FECTMP) + 1;
			 END;
				ELSE
			 BEGIN
				EXEC SP_GEN_DP @FecIni,
							@FECTMP,
							@diaTRA OUTPUT;
			 END;    /* Dias trabajados   */
		  END;
				-- SET @meses = @diatra / 30;
	   END;

	   --Esta tabla es la lista de los conceptos que no deben ser incluídos en la sumatoria
	   IF OBJECT_ID('TempDb..#T_CptosExcluidos') IS NULL
	   BEGIN
		  CREATE TABLE #T_CptosExcluidos(
			  [cod_con] CHAR(6) COLLATE DATABASE_DEFAULT,
			  [mod_liq] CHAR(2) COLLATE DATABASE_DEFAULT,
			  PRIMARY KEY(cod_con, mod_liq)
								  );
	   END;

	   --Esta tabla registra agrupado por bases, los valores y cantidades
	   IF OBJECT_ID('TempDb..#T_BasesReg') IS NULL
	   BEGIN
		  CREATE TABLE #T_BasesReg(
			  [T_Origen] CHAR(1) COLLATE DATABASE_DEFAULT,
			  [base_dia] INT NULL,
			  [cod_base] CHAR(2) COLLATE DATABASE_DEFAULT,
			  [cod_con]  CHAR(6) COLLATE DATABASE_DEFAULT,
			  [mod_liq]  CHAR(2) COLLATE DATABASE_DEFAULT,
			  [nat_liq]  TINYINT,
			  [val_base] MONEY NULL,
			  [can_base] MONEY NULL,
			  [ind_can]  BIT,
			  [ind_val]  BIT,
			  [fec_cte]  DATETIME,
			  [cod_cont] INT,
			  [fec_ini]  DATETIME,
			  [fec_fin]  DATETIME,
			  PRIMARY KEY(T_Origen, fec_cte, cod_con, cod_base, cod_cont, mod_liq)
							 );
	   END;

	   --Tabla para parámetros de funcionamiento adicionales 
	   IF OBJECT_ID('TempDB..#T_ParamAdi') IS NULL
	   BEGIN
		  CREATE TABLE #T_ParamAdi(
			  [info_Advert]      BIT DEFAULT 1, --Variabre para informar o no las advertencias
			  [Solo_T_Resultado] BIT DEFAULT 0, --Variable para no usar los valores históricos de la fecha de corte de la liquidación en curso
			  [Srio_AntesFlexi]  BIT DEFAULT 0, --Variable para indicar que debe usarse como sueldo el de la historia laboral antes de flexibilización
			  [Ind_SVar]         BIT DEFAULT NULL --Variable que si no llega nula sobreescribe el valor de la variable @nIndSvar
							 );

	   END;

	   INSERT INTO #T_ParamAdi( info_Advert )
	   VALUES
			(
			1 );

	   /*Se incluye como conceptos Excluido las novedades fijas con indicador */
	   INSERT INTO #T_CptosExcluidos( cod_con,
							    mod_liq
							  )
	   SELECT cod_con,
			mod_liq
	   FROM V_rhh_concep
	   WHERE ind_valnov = 1 AND cod_bas <> '02' AND cod_con <> '001050';

	   /*Se incluye como conceptos Excluido el transporte cuando esta configurado Valor Mensual */
	   IF @pro_sub = 2
	   BEGIN
		  INSERT INTO #T_CptosExcluidos( cod_con,
								   mod_liq
								 )
		  SELECT cod_con,
			    mod_liq
		  FROM #T_Rhh_ConcepEmp
		  WHERE cod_bas = '02';
	   END;

	   --  Tabla con los contratos válidos para sumar en el rango correspondiente a la fracción
	   IF OBJECT_ID('TempDB..#T_Contratos') IS NULL
	   BEGIN
		  CREATE TABLE #T_Contratos(
			  [cod_cont] INT
							  );
	   END;

	   INSERT INTO #T_Contratos
	   VALUES
			(
			@nCodCont );

	   --  Esata tabla es la lista de las liquidaciones que no deben ser incluídas en la sumatoria
	   IF OBJECT_ID('TempDb..#T_LiquiExcluidos') IS NULL
	   BEGIN
		  CREATE TABLE #T_LiquiExcluidos(
			  [tip_liq] CHAR(2) COLLATE DATABASE_DEFAULT,
			  [fec_cte] DATE,
			  PRIMARY KEY(tip_liq, fec_cte)
								  );
	   END;

	   SET @indicador = CASE
					    WHEN @cConcepto = '001145' THEN 'ind_vad'
					    WHEN @cConcepto = '001130' THEN 'ind_vadf'
					    WHEN @cConcepto = '001146' OR @cConcepto = '008400' THEN 'ind_valc'
					    ELSE @cIndicador
					END;

	   IF @Base_Fin_PerLiq_Hist = 1
	   BEGIN
		  INSERT INTO #T_LiquiExcluidos( tip_liq,
								   fec_cte
								 )
		  VALUES
			    (
			    @cTip_liq, @fFec_cte );
	   END;

	   IF @Base_Fin_PreNom = 1
	   BEGIN
		  EXEC sp_rhh_liqhi04 @cCod_emp,
						  @cTip_liq,
						  @fFec_cte,
						  @nNum_Pas,
						  0,
						  @indicador,
						  @FecIni,
						  @FecFin,
						  0,
						  0,
						  0,
						  @Base_Fin_PreNom,
						  @Base_Fin_PerLiq_Hist,
						  @Base_Fin_Mes_Hist,
						  1,
						  @SrioHisLab,
						  @SrioMesesVari,
						  @SrioProm,
						  @SrioPromMes_a_Mes,
						  @nValorTot OUTPUT,
						  @nBaseDia OUTPUT,
						  @nCanBase OUTPUT,
						  @nBasePromMes OUTPUT,
						  @nBasePorUnidad OUTPUT,
						  0,
						  @nIndSeguim;
	   END;
		  ELSE
	   BEGIN
		  EXEC sp_rhh_liqhi04 @cCod_emp,
						  @cTip_liq,
						  @fFec_cte,
						  @nNum_Pas,
						  0,
						  @indicador,
						  NULL,
						  NULL,
						  NULL,
						  12,
						  0,
						  @Base_Fin_PreNom,
						  @Base_Fin_PerLiq_Hist,
						  @Base_Fin_Mes_Hist,
						  1,
						  @SrioHisLab,
						  @SrioMesesVari,
						  @SrioProm,
						  @SrioPromMes_a_Mes,
						  @nValorTot OUTPUT,
						  @nBaseDia OUTPUT,
						  @nCanBase OUTPUT,
						  @nBasePromMes OUTPUT,
						  @nBasePorUnidad OUTPUT,
						  0,
						  @nIndSeguim;
	   END;

	   SELECT @nInd_SVar = Ind_Svar
	   FROM #T_BasesCol;

	   /* Novedades Fijas - Consulta en Historicos */
	   INSERT INTO #NovFija( cod_con,
						mod_liq,
						nat_con,
						val_nov,
						cod_bas
					   )
	   SELECT DISTINCT
			Con.cod_con,
			Con.mod_liq,
			Con.nat_con,
			dbo.fn_rhh_ValNovFija( cod_emp, @FECTMP, Con.cod_con, 0 ) * CASE nat_con
															    WHEN 2 THEN-1
															    ELSE 1
															END,
			Con.cod_bas
	   FROM #T_Rhh_LiqHis AS His
	   INNER JOIN V_rhh_concep AS Con ON His.cod_con = Con.cod_con AND His.mod_liq = Con.mod_liq
	   WHERE His.ind_vad = CASE @cConcepto
						  WHEN '001145' THEN 1
						  ELSE His.ind_vad
					   END
		    AND His.ind_vadf = CASE @cConcepto
							  WHEN '001130' THEN 1
							  ELSE His.ind_vadf
						   END
		    AND His.ind_valc = CASE @cConcepto
							  WHEN '001146' THEN 1
							  WHEN '008400' THEN 1
							  ELSE His.ind_valc
						   END
		    AND Con.ind_valnov = 1
		    AND His.fec_cte BETWEEN @FecIni AND @FecFin;

	   IF @Ind_VacSalVar = 1
	   BEGIN
		  INSERT INTO #NovFija
		  SELECT DISTINCT
			    Pre.cod_con,
			    Pre.mod_liq,
			    Pre.nat_con,
			    dbo.fn_rhh_ValNovFija( @cCod_emp, @FECTMP, Pre.cod_con, 0 ) * CASE Pre.nat_con
																	WHEN 2 THEN-1
																	ELSE 1
																 END,
			    Con.cod_bas
		  FROM #T_Resultado AS Pre
		  INNER JOIN V_rhh_concep AS Con ON Pre.cod_con = Con.cod_con AND Pre.mod_liq = Con.mod_liq
		  WHERE Pre.ind_vad = CASE @cConcepto
							 WHEN '001145' THEN 1
							 ELSE Pre.ind_vad
						  END
			   AND Pre.ind_vadf = CASE @cConcepto
								 WHEN '001130' THEN 1
								 ELSE Pre.ind_vadf
							  END
			   AND Pre.ind_valc = CASE @cConcepto
								 WHEN '001146' THEN 1
								 WHEN '008400' THEN 1
								 ELSE Pre.ind_valc
							  END
			   AND Pre.ind_valnov = 1
			   AND Pre.cod_con NOT IN( SELECT cod_con
								  FROM #NovFija );
	   END;

/* Se hace la modificacion del cursor, llevandolo primero a una tabla temporal la cual se pueda insertar en la tabla rhh_basesliqpres y el cursor del
		  proceso de calculo de la prestacion */
	   IF EXISTS( SELECT *
			    FROM TEMPDB.dbo.sysobjects
			    WHERE id = OBJECT_ID(N'[TEMPDB].[dbo].[#c_rhh_liqhis_vac]') )
	   BEGIN
		  DROP TABLE #c_rhh_liqhis_vac;
	   END;

	   CREATE TABLE #c_rhh_liqhis_vac(
		   Cod_emp    CHAR(12) COLLATE database_default,
		   cod_cont   INT,
		   cod_con    CHAR(6) COLLATE database_default,
		   mod_liq    CHAR(2) COLLATE database_default,
		   fec_cte    DATETIME,
		   can_liq    MONEY,
		   val_liq    MONEY,
		   nat_liq    TINYINT,
		   cod_bas    CHAR(2) COLLATE database_default,
		   ind_sueldo BIT,
		   origen     CHAR(3) COLLATE database_default
							   );

	   SELECT @nB03Fij = [03],
			@nB04Fij = [04],
			@nB05Fij = [05],
			@nB06Fij = [06],
			@nB07Fij = [07],
			@nB08Fij = [08],
			@nB09Fij = [09],
			@nB10Fij = [10],
			@nB11Fij = [11],
			@nB12Fij = [12],
			@nB13Fij = [13],
			@nB14Fij = [14],
			@nB15Fij = [15],
			@nB16Fij = [16],
			@nB17Fij = [17],
			@nB18Fij = [18],
			@nB19Fij = [19],
			@nB20Fij = [20]
	   FROM( SELECT cod_con,
				 val_nov,
				 cod_bas
		    FROM #NovFija ) AS pvt PIVOT(SUM(val_nov) FOR cod_bas IN([03],
														 [04],
														 [05],
														 [06],
														 [07],
														 [08],
														 [09],
														 [10],
														 [11],
														 [12],
														 [13],
														 [14],
														 [15],
														 [16],
														 [17],
														 [18],
														 [19],
														 [20])) AS P;

	   SET @nB03Fij = ISNULL(@nB03Fij, 0);
	   SET @nB04Fij = ISNULL(@nB04Fij, 0);
	   SET @nB05Fij = ISNULL(@nB05Fij, 0);
	   SET @nB06Fij = ISNULL(@nB06Fij, 0);
	   SET @nB07Fij = ISNULL(@nB07Fij, 0);
	   SET @nB08Fij = ISNULL(@nB08Fij, 0);
	   SET @nB09Fij = ISNULL(@nB09Fij, 0);
	   SET @nB10Fij = ISNULL(@nB10Fij, 0);
	   SET @nB11Fij = ISNULL(@nB11Fij, 0);
	   SET @nB12Fij = ISNULL(@nB12Fij, 0);
	   SET @nB13Fij = ISNULL(@nB13Fij, 0);
	   SET @nB14Fij = ISNULL(@nB14Fij, 0);
	   SET @nB15Fij = ISNULL(@nB15Fij, 0);
	   SET @nB16Fij = ISNULL(@nB16Fij, 0);
	   SET @nB17Fij = ISNULL(@nB17Fij, 0);
	   SET @nB18Fij = ISNULL(@nB18Fij, 0);
	   SET @nB19Fij = ISNULL(@nB19Fij, 0);
	   SET @nB20Fij = ISNULL(@nB20Fij, 0);

	   /*Valores Novedades fijas*/
	   INSERT INTO #c_rhh_liqhis_vac( Cod_emp,
							    cod_cont,
							    cod_con,
							    mod_liq,
							    fec_cte,
							    can_liq,
							    val_liq,
							    nat_liq,
							    cod_bas,
							    origen
							  )
	   SELECT @cCod_emp,
			@nCodCont,
			cod_con,
			mod_liq,
			@FECTMP,
			30,
			val_nov,
			nat_con,
			'05',
			'NFH'
	   FROM #NovFija;

	   IF @SrioPromMes_a_Mes = 1
	   BEGIN
		  DECLARE @CanLiq MONEY;

		  SELECT @CanLiq = SUM(can_base)
		  FROM #T_BasesReg
		  WHERE T_Origen = 'S';

		  INSERT INTO #c_rhh_liqhis_vac( Cod_emp,
								   cod_cont,
								   cod_con,
								   mod_liq,
								   fec_cte,
								   can_liq,
								   val_liq,
								   nat_liq,
								   cod_bas,
								   origen
								 )
		  SELECT @cCod_emp,
			    @nCodCont,
			    cod_con,
			    mod_liq,
			    fec_cte,
			    @CanLiq,
			    ROUND(val_base, 0),
			    nat_liq,
			    '01',
			    'SPM'
		  FROM #T_BasesReg
		  WHERE T_Origen = 'S' AND val_base <> 0;
	   END;

	   IF @SrioHisLab = 1
	   BEGIN
		  INSERT INTO #c_rhh_liqhis_vac( Cod_emp,
								   cod_cont,
								   cod_con,
								   mod_liq,
								   fec_cte,
								   can_liq,
								   val_liq,
								   nat_liq,
								   cod_bas,
								   origen
								 )
		  SELECT @cCod_emp,
			    @nCodCont,
			    cod_con,
			    mod_liq,
			    @FECTMP,
			    SUM(can_base),
			    ROUND(SUM(val_base) / SUM(can_base) * 30, 0),
			    nat_liq,
			    '01',
			    'SB'
		  FROM #T_BasesReg
		  WHERE T_Origen = 'S' AND val_base <> 0
		  GROUP BY cod_con,
				 mod_liq,
				 nat_liq;
	   END;

	   INSERT INTO #c_rhh_liqhis_vac( Cod_emp,
							    cod_cont,
							    cod_con,
							    mod_liq,
							    fec_cte,
							    can_liq,
							    val_liq,
							    nat_liq,
							    cod_bas,
							    origen
							  )
	   SELECT @cCod_emp,
			@nCodCont,
			cod_con,
			mod_liq,
			fec_cte,
			can_base,
			val_base,
			1,
			cod_base,
			'HIS'
	   FROM #T_BasesReg
	   WHERE T_Origen IN(
					 'F', 'H', 'C'
					) AND val_base <> 0;

	   INSERT INTO #c_rhh_liqhis_vac( Cod_emp,
							    cod_cont,
							    cod_con,
							    mod_liq,
							    fec_cte,
							    can_liq,
							    val_liq,
							    nat_liq,
							    cod_bas,
							    origen
							  )
	   SELECT @cCod_emp,
			@nCodCont,
			cod_con,
			mod_liq,
			fec_cte,
			can_base,
			val_base,
			1,
			cod_base,
			'MES'
	   FROM #T_BasesReg
	   WHERE T_Origen = 'P' AND val_base <> 0;

	   IF(@IndLiq = 1 AND @diasIng = 0
		)  /* Liquidacion Contrato */
	   BEGIN
		  IF @nIndPdias = 1
		  BEGIN
			 SET @diasIng = 365;
		  END;
			 ELSE
		  BEGIN
			 SET @diasIng = 360;
		  END;

	   END;

	   SET @nPropBasesCalcPrest = CONVERT(BIT, dbo.fn_rhh_VG( 135, NULL ));

	   IF @ctip_liq = '04' AND @IndLiq = 1 /*2014-0970*/
	   BEGIN
		  IF @diasIng < 30 AND @nPropBasesCalcPrest = 0
		  BEGIN /*2013-0401*/
			 SET @diasIng = 30;
		  END;

	   END;

	   IF @ctip_liq = '04' AND @diasIng < 30
	   BEGIN
		  UPDATE #c_rhh_liqhis_vac
		    SET can_liq = @diasIng
		  WHERE cod_con NOT IN( '001050', '001203', '001130', '001150', '001151', '001152', '001153', '001155', '001170' );
	   END;
		  ELSE
	   BEGIN
		  UPDATE #c_rhh_liqhis_vac
		    SET can_liq = @diatra
		  WHERE cod_con NOT IN( '001050', '001203', '001130', '001150', '001151', '001152', '001153', '001155', '001170' );
	   END;

	   IF @nIndConsolidado = 0
	   BEGIN
		  EXEC sp_rhh_SueldoFch @cCod_emp,
						    @nCodCont,
						    @fec_sal,
						    @nIndInclRetro,
						    0,
						    @nSueldo OUTPUT;
	   END;
		  ELSE
	   BEGIN
		  EXEC sp_rhh_SueldoFch @cCod_emp,
						    @nCodCont,
						    @fFec_cte,
						    @nIndInclRetro,
						    0,
						    @nSueldo OUTPUT;
	   END;

	   IF @nIndConsolidado = 1
	   BEGIN
		  SET @Sal_AntFlex = dbo.fn_rhh_SalAntFlex( @cCod_emp, @fFec_cte, 2, 0 );
	   END;
		  ELSE
	   BEGIN
		  SET @Sal_AntFlex = dbo.fn_rhh_SalAntFlex( @cCod_emp, @fec_sal, 2, 0 );
	   END;

	   /*2013-0370*/
	   IF @Sal_AntFlex > 0 AND @vg138 = 1 AND @cConcepto = '001145'
	   BEGIN
		  SET @nSueldo = @Sal_AntFlex;
	   END;

	   IF @Sal_AntFlex > 0 AND @cTip_liq = '04' AND @cConcepto = '001146'
	   BEGIN
		  SET @nSueldo = @Sal_AntFlex;
	   END;

	   IF @cTip_liq = '15'
	   BEGIN /* Liquidacion Proyecciones Salariales */
		  SET @nSueldo = (@nSueldo * (@proy_sal / 100)) + @nSueldo;
	   END;

	   /* Se cálcula el salario Variable unicamente si el sueldo actual es igual a 0 - Empleado con indicador de Variable y contrato con indicador de Promedio para vacaciones*/
	   IF(@nSueldo = 0 AND @nSuelVar > 0
		) OR (@nind_SueldoSvar = 2 AND @nInd_SVar = 1
			)
	   BEGIN
		  SET @nSuelVar = ROUND(@nSuelVar / @diaTRA * 30, 0);
		  SET @nSueldo = 0;
		  UPDATE #c_rhh_liqhis_vac
		    SET can_liq = @diatra
		  WHERE cod_con IN( '001050', '001203', '001130', '001150', '001151', '001152', '001153', '001155', '001170' );
	   END;
		  ELSE
	   BEGIN
		  SELECT @ModConcep = mod_liq
		  FROM V_rhh_concep
		  WHERE cod_con = '001050'
			   AND mod_liq = ( SELECT MAX(mod_liq)
						    FROM V_rhh_concep AS Sc
						    WHERE Sc.cod_con = V_rhh_concep.cod_con AND (mod_liq = @ModLiq OR mod_liq = '0'
															   ) );

		  SET @nSuelVar = 0;

		  DELETE #c_rhh_liqhis_vac
		  WHERE cod_con IN( '001050', '001203', '001130', '001150', '001151', '001152', '001153', '001155', '001170' );

		  -- Insert de solo un registro de sueldo a la fecha de corte de la liquidacion
		  INSERT INTO #c_rhh_liqhis_vac( Cod_emp,
								   cod_cont,
								   cod_con,
								   mod_liq,
								   fec_cte,
								   can_liq,
								   val_liq,
								   nat_liq,
								   cod_bas,
								   ind_sueldo,
								   origen
								 )
		  VALUES
			    (
			    @cCod_emp, @nCodCont, '001050', @ModConcep, @FECTMP, 30, @nSueldo, 1, '01', 0, 'SB' );
	   END;

	   SELECT @nValBase02 = ISNULL(SUM(val_liq), 0)
	   FROM #t_rhh_LiqHis AS liq
	   INNER JOIN v_rhh_concep AS cto ON liq.cod_con = cto.cod_con AND cto.mod_liq = liq.mod_liq
	   WHERE liq.fec_cte >= @FecIni
		    AND liq.fec_cte <= @FecFin
		    AND cto.cod_bas = '02'
		    AND liq.cod_cont = @nCodCont
		    AND liq.val_liq <> 0
		    AND CASE @cConcepto
				  WHEN '001145' THEN liq.ind_vad
				  WHEN '001146' THEN liq.ind_valc
				  WHEN '008400' THEN liq.ind_valc
				  WHEN '001130' THEN liq.ind_vadf
			   END = 1;

	   SELECT @nValBase02 = @nValBase02 + ISNULL(SUM(val_liq), 0)
	   FROM #t_resultado AS liq
	   INNER JOIN #T_Rhh_ConcepEmp AS cto ON liq.cod_con = cto.cod_con AND cto.mod_liq = liq.mod_liq
	   WHERE cto.cod_bas = '02'
		    AND liq.val_liq <> 0
		    AND CASE @cConcepto
				  WHEN '001145' THEN cto.ind_vad
				  WHEN '001146' THEN cto.ind_valc
				  WHEN '008400' THEN liq.ind_valc
				  WHEN '001130' THEN cto.ind_vadf
			   END = 1;

	   IF @nValBase02 = 0 AND @Base_Fin_PreNom = 1
	   BEGIN

		  SELECT @bSTrans = 0;
		  DELETE #c_rhh_liqhis_vac
		  WHERE cod_bas = '02';
	   END;
		  ELSE
	   BEGIN
		  IF @pro_sub = 2
			AND ( SELECT CASE @cConcepto
						  WHEN '001145' THEN ind_vad
						  WHEN '001146' THEN ind_valc
						  WHEN '008400' THEN ind_valc
						  WHEN '001130' THEN ind_vadf
					   END
				 FROM #T_Rhh_ConcepEmp AS C
				 WHERE C.cod_con = '001300' ) = 1
			AND @cConcepto IN('001145', '001146', '001130', '008400')
		  BEGIN
			 SELECT @ModConcep = mod_liq
			 FROM V_rhh_concep
			 WHERE cod_con = '001300'
				  AND mod_liq = ( SELECT MAX(mod_liq)
							   FROM V_rhh_concep AS Sc
							   WHERE Sc.cod_con = V_rhh_concep.cod_con AND (mod_liq = @ModLiq OR mod_liq = '0'
																  ) );

			 SELECT @bSTrans = @nVlrSub;
	 
			 DELETE #c_rhh_liqhis_vac
			 WHERE cod_con = '001300';
			 INSERT INTO #c_rhh_liqhis_vac( cod_emp,
									  cod_cont,
									  cod_con,
									  mod_liq,
									  fec_cte,
									  can_liq,
									  val_liq,
									  nat_liq,
									  cod_bas,
									  origen
									)
			 VALUES
				   (
				   @cCod_emp, @nCodCont, '001300', @ModConcep, @fec_sal, 30, @bSTrans, 1, '02', 'AT' );
		  END;
	   END;
	   
	   IF @nIndConsolidado = 0 AND @nIndRetBase = 0
	   BEGIN
		  DELETE RHH_BASESLIQPRES
		  WHERE cod_emp = @cCod_emp
			   AND iden = (CASE @cConcepto
						    WHEN '001146' THEN 11
						    WHEN '001130' THEN 12
						    WHEN '001145' THEN 13
						    ELSE 'N/D'
						END
					    )
			   AND tip_liq = @cTip_liq
			   AND fec_liqproc = @fFec_liq
			   AND fec_cteProc = @fFec_cte
			   AND cod_cont = @nCodCont;

		  DELETE RHH_BASESLIQPRES
		  WHERE cod_emp = @cCod_emp
			   AND iden IN( 11, 12, 13 )
		  AND tip_liq = @cTip_liq
		  AND fec_liqproc = @fFec_liq
		  AND fec_cteProc = @fFec_cte
		  AND cod_cont = @nCodCont
		  AND cod_con = 'PARAM';

		  INSERT INTO #t_Error( cod_emp,
						    cod_cont,
						    error,
						    tip_liq,
						    cod_con,
						    num_pas,
						    fec_liq,
						    fec_cte
						  )
		  SELECT cod_emp,
			    cod_cont,
			    cod_con +
			    '-Concepto con Indicador Valor de la Novedad Para Cálculo de Prestaciones y No tiene definido Valor de Novedad Fija en la fecha de proceso ',
			    @cTip_liq,
			    @cConcepto,
			    @nNum_Pas,
			    @fFec_liq,
			    @fFec_cte
		  FROM #c_rhh_liqhis_vac
		  WHERE origen = 'NFH' AND val_liq IS NULL;

		  SELECT @cNomCar = nom_car
		  FROM rhh_cargos
		  WHERE cod_car = @cod_car;

		  UPDATE #c_rhh_liqhis_vac
		    SET val_liq = 0
		  FROM #c_rhh_liqhis_vac TB
		  WHERE origen = 'NFH' AND val_liq IS NULL;

		  INSERT INTO rhh_basesliqpres( cod_emp,
								  iden,
								  tip_liq,
								  cod_cont,
								  cod_bas,
								  cod_con,
								  mod_liq,
								  nat_liq,
								  fec_cte,
								  fec_liqproc,
								  fec_cteProc,
								  dias,
								  val_liq,
								  cod_conv,
								  sal_bas,
								  dia_base,
								  Dias_tot,
								  tabla,
								  idl_num
								)
		  SELECT TB.Cod_emp,
			    CASE @cConcepto
				   WHEN '001146' THEN 11
				   WHEN '001130' THEN 12
				   WHEN '001145' THEN 13
				   ELSE 'N/D'
			    END,
			    @cTip_liq,
			    TB.cod_cont,
			    TB.cod_bas,
			    TB.cod_con,
			    TB.mod_liq,
			    TB.nat_liq,
			    TB.fec_cte,
			    @fFec_liq,
			    @fFec_cte,
			    TB.can_liq,
			    TB.val_liq,
			    @cod_conv,
			    @nSueldo,
			    CASE @nPropBasesCalcPrest
				   WHEN 0 THEN(@diaTRA)
				   ELSE 30
			    END,
			    (@nHabdis + @nNhadis - @nIndDesc31),
			    @nom_con,
			    @IDL_NUM
		  FROM #c_rhh_liqhis_vac AS TB;

		  INSERT INTO rhh_basesliqpres( cod_emp,
								  iden,
								  Tip_liq,
								  fec_liqproc,
								  fec_cteProc,
								  dias,
								  cod_con,
								  cod_cont,
								  ind_pdias,
								  ind_svar,
								  reg_sal,
								  aux_tra,
								  vg135,
								  Vpro_vac,
								  Vtrn_vac,
								  VInd_VacSalVar,
								  VInd_VacSalVarLC,
								  tip_con,
								  nom_cont,
								  sal_bas,
								  fec_ing,
								  fec_ret,
								  cod_car,
								  nom_car,
								  tabla,
								  idl_num,
								  cod_conv
								)
		  SELECT @cCod_emp,
			    CASE @cConcepto
				   WHEN '001146' THEN 11
				   WHEN '001130' THEN 12
				   WHEN '001145' THEN 13
				   ELSE 'N/D'
			    END,
			    @cTip_liq,
			    @fFec_liq,
			    @fFec_cte,
			    @nBaseDia,
			    'PARAM',
			    @nCodCont,
			    @nIndPdias,
			    @nInd_SVar,
			    @nReg_sal,
			    @aux_tra,
			    @nPropBasesCalcPrest,
			    @pro_vac,
			    @pro_sub,
			    @Ind_VacSalVar,
			    @Ind_VacSalVarLC,
			    @tip_con,
			    @cNomCon,
			    @nSueldo,
			    @Fec_ing,
			    @fec_ret,
			    @cod_car,
			    @cNomCar,
			    @nom_con,
			    @IDL_NUM,
			    @cod_conv;
	   END;

	   SELECT @ValNovFij = ISNULL(SUM(VAL_NOV), 0)
	   FROM #NovFija;

	   IF @ValNovFij > 0
	   BEGIN
		  INSERT INTO #t_Error( cod_emp,
						    cod_cont,
						    error,
						    tip_liq,
						    num_pas,
						    fec_liq,
						    fec_cte,
						    cod_con
						  )
		  SELECT @cCod_emp,
			    @nCodCont,
			    'Advertencia. El Concepto ' + cod_con + ' no tiene asignada una base para ser reportado',
			    @cTip_liq,
			    @nNum_Pas,
			    @fFec_liq,
			    @fFec_cte,
			    @cConcepto
		  FROM #NovFija
		  WHERE cod_bas = '0';
	   END;

	   IF((@cConcepto = '001145' AND @vg138 = 1
		 )
		 OR (@nIndConsolidado = 1 AND @vg147 = 1
		    )
		 OR @cConcepto = '001146'
		)
		AND @Sal_AntFlex > 0
	   BEGIN
		  SELECT @nBasePromMes = @nBasePromMes - SUM(b01_liq)
		  FROM #T_BasesCol;

		  SET @nBasePromMes = @nBasePromMes + @Sal_AntFlex;

		  UPDATE #T_BasesCol
		    SET b01_liq = 0;

		  UPDATE #T_BasesCol
		    SET b01_liq = @Sal_AntFlex
		  WHERE T_Origen = 'S';

		  SELECT @nBase = ROUND(@nBasePromMes, 0) + @bSTrans + @ValNovFij;
	   END;
		  ELSE
	   BEGIN
		  IF @nind_SueldoSvar = 1
		  BEGIN
			 SELECT @nBasePromMes = @nBasePromMes - SUM(b01_liq)
			 FROM #T_BasesCol;

			 SELECT @nBase = @nBasePromMes + ROUND(@nSueldo, 0) + @bSTrans + @ValNovFij;

			 UPDATE #T_BasesCol
			   SET b01_liq = @nSueldo
			 WHERE b01_liq <> 0;
		  END;
			 ELSE
		  BEGIN
			 SELECT @nBase = ROUND(@nBasePromMes, 0) + @bSTrans + @ValNovFij;
		  END;
	   END;

	   IF @diaTRA < 30 AND @nPropBasesCalcPrest = 0
	   BEGIN
		  SET @nDiaAus = dbo.fn_rhh_ausent01( @cCod_emp, @fec_ing, @dFEC_HIS, 1 );

		  UPDATE #T_BasesCol
		    SET b03_liq = ROUND(b03_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b04_liq = ROUND(b04_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b05_liq = ROUND(b05_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b06_liq = ROUND(b06_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b07_liq = ROUND(b07_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b08_liq = ROUND(b08_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b09_liq = ROUND(b09_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b10_liq = ROUND(b10_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b11_liq = ROUND(b11_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b12_liq = ROUND(b12_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b13_liq = ROUND(b13_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b14_liq = ROUND(b14_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b15_liq = ROUND(b15_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b16_liq = ROUND(b16_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b17_liq = ROUND(b17_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b18_liq = ROUND(b18_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b19_liq = ROUND(b19_liq / 30 * (@diaTRA - @nDiaAus), 0),
			   b20_liq = ROUND(b20_liq / 30 * (@diaTRA - @nDiaAus), 0);

		  SELECT @nBase = SUM(b01_liq + b02_liq + b03_liq + b04_liq + b05_liq + b06_liq + b07_liq + b08_liq + b09_liq + b10_liq + b11_liq + b12_liq
		  + b13_liq + b14_liq + b15_liq + b16_liq + b17_liq + b18_liq + b19_liq + b20_liq)
		  FROM #T_BasesCol;

		  IF @nInd_SVar = 1 AND (@nBase + @ValNovFij <= 2 * @nSalmin) AND @pro_sub = 2
		  BEGIN
			 IF @nSalBas <= (2 * @nSalMin)
			 BEGIN
				SET @bSTrans = @nVlrSub;

				DELETE #c_rhh_liqhis_vac
				WHERE cod_bas = '02';
				INSERT INTO #c_rhh_liqhis_vac( cod_con,
										 mod_liq,
										 fec_cte,
										 can_liq,
										 val_liq,
										 nat_liq,
										 cod_bas,
										 origen
									    )
				VALUES
					  (
					  '001300', @ModLiq, @FECTMP, 30, @bSTrans, 1, '02', 'AT' );
			 END;
		  END;

		  SELECT @nBase = ROUND(@nBase, 0) + @bSTrans + @ValNovFij;
	   END;

	   SELECT @nValor = ROUND((@nBase / 30) * (@nHabdis + @nNhadis - @nIndDesc31), 0);

	   IF EXISTS( SELECT *
			    FROM TEMPDB.dbo.sysobjects
			    WHERE id = OBJECT_ID(N'[TEMPDB].[dbo].[#c_rhh_liqhis_vac]') )
	   BEGIN
		  DROP TABLE #c_rhh_liqhis_vac;
	   END;

	   IF @nIndRetBase = 1
	   BEGIN
		  RETURN(0);
	   END;

	   IF @nValor <> 0 AND @nValor IS NOT NULL AND @cTip_liq <> '15' AND @nIndConsolidado = 0
	   BEGIN
		  DELETE FROM rhh_pagvaca
		  WHERE cod_emp = @cCod_emp
			   AND cod_con = @cConcepto
			   AND cod_ano = @cAno
			   AND cod_per = @cPer
			   AND fec_cte = @fFec_cte
			   AND cod_cont = @nCodCont;

		  IF( SELECT COUNT(T_Origen)
			 FROM #T_BasesCol ) > 0
		  BEGIN
			 INSERT INTO rhh_pagvaca( cod_emp,
								 cod_con,
								 cod_cia,
								 cod_suc,
								 cod_cco,
								 cod_cl1,
								 cod_cl2,
								 cod_cl3,
								 cod_cl4,
								 cod_cl5,
								 cod_cl6,
								 cod_cl7,
								 cod_ano,
								 cod_per,
								 fec_liq,
								 tip_liq,
								 dia_hab,
								 dia_nha,
								 val_liq,
								 b01_liq,
								 b02_liq,
								 b03_liq,
								 b04_liq,
								 b05_liq,
								 b06_liq,
								 b07_liq,
								 b08_liq,
								 b09_liq,
								 b10_liq,
								 b11_liq,
								 b12_liq,
								 b13_liq,
								 b14_liq,
								 b15_liq,
								 b16_liq,
								 b17_liq,
								 b18_liq,
								 b19_liq,
								 b20_liq,
								 fec_cte,
								 cod_cont
							    )
			 SELECT @cCod_emp,
				   @cConcepto,
				   @cCod_cia,
				   @cCod_suc,
				   @cCod_cco,
				   @cCod_cl1,
				   @cCod_cl2,
				   @cCod_cl3,
				   @cCod_cl4,
				   @cCod_cl5,
				   @cCod_cl6,
				   @cCod_cl7,
				   @cAno,
				   @cPer,
				   @fFec_liq,
				   @cTip_liq,
				   @nHabDis,
				   @nNhaDis,
				   @nValor,
				   ROUND(SUM(b01_liq), 0),
				   ROUND(SUM(b02_liq), 0) + @bSTrans,
				   ROUND(SUM(b03_liq), 0) + @nB03Fij,
				   ROUND(SUM(b04_liq), 0) + @nB04Fij,
				   ROUND(SUM(b05_liq), 0) + @nB05Fij,
				   ROUND(SUM(b06_liq), 0) + @nB06Fij,
				   ROUND(SUM(b07_liq), 0) + @nB07Fij,
				   ROUND(SUM(b08_liq), 0) + @nB08Fij,
				   ROUND(SUM(b09_liq), 0) + @nB09Fij,
				   ROUND(SUM(b10_liq), 0) + @nB10Fij,
				   ROUND(SUM(b11_liq), 0) + @nB11Fij,
				   ROUND(SUM(b12_liq), 0) + @nB12Fij,
				   ROUND(SUM(b13_liq), 0) + @nB13Fij,
				   ROUND(SUM(b14_liq), 0) + @nB14Fij,
				   ROUND(SUM(b15_liq), 0) + @nB15Fij,
				   ROUND(SUM(b16_liq), 0) + @nB16Fij,
				   ROUND(SUM(b17_liq), 0) + @nB17Fij,
				   ROUND(SUM(b18_liq), 0) + @nB18Fij,
				   ROUND(SUM(b19_liq), 0) + @nB19Fij,
				   ROUND(SUM(b20_liq), 0) + @nB20Fij,
				   @fFec_cte,
				   @nCodCont
			 FROM #T_BasesCol;
		  END;

		  IF @cConcepto = '001130'
		  BEGIN
			 UPDATE rhh_hisvac
			   SET val_vac = ROUND((@nValor / (@nHabDis + @nNhadis)) * (hab_dis + nha_dis), 2)
		  WHERE cod_emp = @cCod_emp AND fec_vac = @fFec_cte AND tip_liq = @cTip_liq;
		  END;

		  IF @cConcepto IN('001145')
		  BEGIN
			 UPDATE rhh_hisvac
			   SET val_din = ROUND(@nValor / (@nHabDis + @nNhadis) * (hab_pag + nha_pag), 2)
		  WHERE cod_emp = @cCod_emp AND fec_vac = @fFec_cte AND tip_liq = @cTip_liq;
		  END;

		  IF @cConcepto IN('001146')
		  BEGIN
			 UPDATE rhh_hisvac
			   SET val_din = @nValor
			 WHERE cod_emp = @cCod_emp AND fec_his = @dfec_his AND tip_liq = @cTip_liq;
		  END;

	   END;
    END;

    SET @nValProvis = 0;
    SET @nValPag = 0;
    SET @DiaVacPag = 0;
    SET @nValVac = 0;
    SET @nValAjusAnte = 0;
    SET @nValDife = 0;

    SET @nValVac = @nValor;

    IF @nIndConsolidado = 1
    BEGIN
	   DECLARE @mes CHAR(2);
	   DECLARE @Cons_AnoAnt MONEY;
	   DECLARE @Cons_MesAnt MONEY;
	   DECLARE @Cons_PagosAnt MONEY;
	   DECLARE @Cons_PagosMes MONEY;
	   DECLARE @ValProvMes MONEY;

	   SET @Cons_AnoAnt = 0;
	   SET @Cons_MesAnt = 0;
	   SET @Cons_PagosAnt = 0;
	   SET @Cons_PagosMes = 0;
	   SET @ValProvMes = 0;

	   SELECT @Cons_AnoAnt = ISNULL(SUM(val_vac), 0)
	   FROM rhh_Consvaca
	   WHERE cod_emp = @cCod_emp
		    AND fec_cte = EOMONTH(CONVERT(CHAR(4), YEAR(DATEADD(YEAR, -1, @fFec_cte))) + '1201');

	   IF NOT EXISTS( SELECT val_vac
				   FROM rhh_Consvaca
				   WHERE cod_emp = @cCod_emp AND fec_cte = EOMONTH(DATEADD(MONTH, -1, @fFec_cte)) )
	   BEGIN
		  SELECT @Cons_MesAnt = ISNULL(SUM(val_liq), 0)
		  FROM #t_rhh_LiqHis
		  WHERE cod_cont = @nCodCont
			   AND cod_con = '002970'
			   AND fec_cte = EOMONTH(DATEADD(MONTH, -1, @fFec_cte));
	   END;
		  ELSE
	   BEGIN
		  SELECT @Cons_MesAnt = ISNULL(SUM(val_vac), 0)
		  FROM rhh_Consvaca
		  WHERE cod_emp = @cCod_emp AND fec_cte = EOMONTH(DATEADD(MONTH, -1, @fFec_cte));
	   END;

	   SELECT @Cons_PagosAnt = ISNULL(SUM(val_liq), 0)
	   FROM #t_rhh_LiqHis
	   WHERE cod_emp = @cCod_emp
		    AND cod_con IN(
					    CASE @vg139
						   WHEN 1 THEN '000050'
						   ELSE '001130'
					    END, '001145', '001146'
					   )
		    AND fec_cte BETWEEN CONVERT(CHAR(4), YEAR(DATEADD(YEAR, -1, @fFec_cte))) + '0101' AND EOMONTH(DATEADD(MONTH, -1, @fFec_cte))
		    AND cod_cont = @nCodCont;

	   IF @cTip_liq = '14'
	   BEGIN
		  SELECT @Cons_PagosMes = ISNULL(SUM(val_liq), 0)
		  FROM #t_rhh_LiqHis
		  WHERE cod_cont = @nCodCont
			   AND cod_con IN(
						   CASE @vg139
							  WHEN 1 THEN '000050'
							  ELSE '001130'
						   END, '001145', '001146'
						  )
			   AND ano_liq = @cAno
			   AND per_liq = @cPer;

		  SELECT @ValProvMes = ISNULL(SUM(val_liq), 0)
		  FROM #t_rhh_LiqHis
		  WHERE cod_cont = @nCodCont AND cod_con = @cCodConProv AND ano_liq = @cAno AND per_liq = @cPer;

		  SELECT @diasvac_consol = diasvac_consol,
			    @dias_vac = dias_vac
		  FROM rhh_hisdiasvac
		  WHERE cod_emp = @cCod_emp
			   AND ((@fFec_cte BETWEEN fec_ini AND fec_fin OR (@fFec_cte >= fec_ini AND fec_fin IS NULL
													)
				   )
				  );
	   END;

	   DELETE FROM Rhh_ConsVaca
	   WHERE cod_emp = @cCod_emp AND fec_cte = @fFec_cte;

	   SET @dias_Pen = @nHabDis + @nNhadis;

	   IF @cTip_liq = '04'
	   BEGIN
		  SET @nValVac = ROUND(@nBase / 30 * @dias_Pen, 0);
	   END;
		  ELSE
	   BEGIN
		  SET @dias_Pen = ROUND(@dias_Pen * @diasvac_consol / @dias_vac, 2);
		  SET @nValVac = ROUND(@nBase / 30 * @dias_Pen, 0);
	   END;

	   IF @vg140 = 0 AND @nValVac < 0
	   BEGIN
		  SET @nValor = 0;
		  SET @nValVac = 0;
	   END;

	   SELECT @nValProvis = @ValProvMes + ISNULL(SUM(val_liq), 0)
	   FROM rhh_liqhis
	   WHERE cod_emp = @cCod_emp
		    AND cod_con = @cCodConProv
		    AND fec_cte >= @fec_ing
		    AND fec_cte < @fFec_cte
		    AND cod_cont = @nCodCont;

	   IF @cTip_liq = '04'
	   BEGIN
		  SELECT @nValPag = ISNULL(SUM(val_liq), 0),
			    @DiaVacPag = ISNULL(SUM(can_liq), 0)
		  FROM rhh_liqhis
		  WHERE cod_emp = @cCod_emp
			   AND cod_con IN(
						   CASE @vg139
							  WHEN 1 THEN '000050'
							  ELSE '001130'
						   END, '001145', '001146'
						  )
			   AND fec_cte >= @fec_ing
			   AND fec_cte < @fFec_cte
			   AND cod_cont = @nCodCont;
	   END;
		  ELSE
	   BEGIN
		  SELECT @nValPag = ISNULL(SUM(val_liq), 0),
			    @DiaVacPag = ISNULL(SUM(can_liq), 0)
		  FROM rhh_liqhis
		  WHERE cod_emp = @cCod_emp
			   AND cod_con IN(
						   CASE @vg139
							  WHEN 1 THEN '000050'
							  ELSE '001130'
						   END, '001145'
						  )
			   AND fec_cte >= @fec_ing
			   AND fec_cte <= @fFec_cte
			   AND cod_cont = @nCodCont;
	   END;

	   IF @cTip_liq = '04'
	   BEGIN
		  SELECT @Cons_PagosMes = @Cons_PagosMes + ISNULL(SUM(val_liq), 0)
		  FROM #T_Resultado
		  WHERE cod_con IN(
					    '001130', '001145', '001146'
					   );

		  /*Cuando es liquidacion de contrato se consulta la informacion calculada para el concepto 001146*/
		  SELECT @nValVac = ISNULL(SUM(val_liq), 0)
		  FROM #T_Resultado
		  WHERE cod_con IN( '001146' );

		  SELECT @nValPag = @nValPag + ISNULL(SUM(val_liq), 0),
			    @DiaVacPag = @DiaVacPag + ISNULL(SUM(can_liq), 0)
		  FROM #T_Resultado
		  WHERE cod_con IN(
					    CASE @vg139
						   WHEN 1 THEN '000050'
						   ELSE '001130'
					    END, '001145'
					   );

		  SELECT @nValProvis = @nValProvis + ISNULL(SUM(val_liq), 0)
		  FROM #T_Resultado
		  WHERE cod_con = @cCodConProv;

		  SELECT @ValProvMes = @ValProvMes + ISNULL(SUM(val_liq), 0)
		  FROM #T_Resultado
		  WHERE cod_con = @cCodConProv;
	   END;

	   SELECT @nValAjusAnte = ISNULL(SUM(val_liq), 0)
	   FROM rhh_liqhis
	   WHERE cod_emp = @cCod_emp
		    AND cod_con = @cCodConAju
		    AND fec_cte >= @fec_ing
		    AND fec_Cte < @fFec_cte
		    AND cod_cont = @nCodCont;

	   /**A los días de vacaciones se suma el valor pagado para calcular la diferencia real**/
	   SET @nValDife = (@nValVac + @nValPag) - @nValProvis - @nValAjusAnte;

	   IF @nValVac IS NOT NULL OR (@nValVac + @nValPag) <> 0
	   BEGIN
		  SELECT @nDiaPerAcum = ISNULL(SUM(hab_dis + hab_pag), 0)
		  FROM rhh_hisvac
		  WHERE cod_emp = @cCod_emp AND fec_sal >= @fec_ing AND fec_his <= @dFEC_HIS;		/* 2013-1021 - 2013-11*/

		  IF @nIndPdias = 0
		  BEGIN
			 SET @nDiaCau = dbo.fn_gen_DP( @fec_ing, @dFEC_HIS );
			 SET @nDiaAus = dbo.fn_rhh_ausent01( @cCod_emp, @fec_ing, @dFEC_HIS, 1 );
			 SET @nDiaCau = @nDiaCau - @nDiaAus;
		  END;
			 ELSE
		  BEGIN
			 SET @nDiaCau = DATEDIFF(DAY, @fec_ing, @dFEC_HIS) + 1;
			 SET @nDiaAus = dbo.fn_rhh_ausent01( @cCod_emp, @fec_ing, @dFEC_HIS, 1 );
			 SET @nDiaCau = @nDiaCau - @nDiaAus;
		  END;

		  IF( SELECT COUNT(T_Origen)
			 FROM #T_BasesCol ) > 0
		  BEGIN
			 INSERT INTO Rhh_ConsVaca( cod_emp,
								  cod_con,
								  cod_cia,
								  cod_suc,
								  cod_cco,
								  cod_cl1,
								  cod_cl2,
								  cod_cl3,
								  cod_cl4,
								  cod_cl5,
								  cod_cl6,
								  cod_cl7,
								  fec_liq,
								  tip_liq,
								  fec_ing,
								  fec_Ini_Cau,
								  fec_fin_cau,
								  Dia_cau,
								  Dia_per_cau,
								  val_vac,
								  sal_bas,
								  sal_prom,
								  val_acu,
								  dia_per_acum,
								  val_provi,
								  val_dife,
								  fec_cte,
								  val_vacPag,
								  Dia_tot_vac,
								  b01_liq,
								  b02_liq,
								  b03_liq,
								  b04_liq,
								  b05_liq,
								  b06_liq,
								  b07_liq,
								  b08_liq,
								  b09_liq,
								  b10_liq,
								  b11_liq,
								  b12_liq,
								  b13_liq,
								  b14_liq,
								  b15_liq,
								  b16_liq,
								  b17_liq,
								  b18_liq,
								  b19_liq,
								  b20_liq,
								  cod_cont,
								  Cons_AnoAnt,
								  Cons_MesAnt,
								  Cons_PagosAnt,
								  Cons_PagosMes,
								  ValProvMes
								)
			 SELECT @cCod_emp,
				   @cConcepto,
				   @cCod_Cia,
				   @cCod_Suc,
				   @cCod_Cco,
				   @cCod_Cl1,
				   @cCod_Cl2,
				   @cCod_Cl3,
				   @cCod_Cl4,
				   @cCod_Cl5,
				   @cCod_Cl6,
				   @cCod_Cl7,
				   @fFec_liq,
				   @cTip_liq,
				   @fec_ing,
				   @fec_ing,
				   @fFec_cte,
				   @nDiaCau,
				   @dias_Pen,
				   @nValVac,
				   @nSalBas,
				   @nBase,
				   @nBase,
				   @nDiaPerAcum,
				   @nValProvis + @nValAjusAnte,
				   @nValDife,
				   @fFec_cte,
				   @nValPag,
				   ISNULL(@nDiaPerCau, 0),
				   ROUND(SUM(b01_liq), 0),
				   ROUND(SUM(b02_liq), 0) + @bSTrans,
				   ROUND(SUM(b03_liq), 0) + @nB03Fij,
				   ROUND(SUM(b04_liq), 0) + @nB04Fij,
				   ROUND(SUM(b05_liq), 0) + @nB05Fij,
				   ROUND(SUM(b06_liq), 0) + @nB06Fij,
				   ROUND(SUM(b07_liq), 0) + @nB07Fij,
				   ROUND(SUM(b08_liq), 0) + @nB08Fij,
				   ROUND(SUM(b09_liq), 0) + @nB09Fij,
				   ROUND(SUM(b10_liq), 0) + @nB10Fij,
				   ROUND(SUM(b11_liq), 0) + @nB11Fij,
				   ROUND(SUM(b12_liq), 0) + @nB12Fij,
				   ROUND(SUM(b13_liq), 0) + @nB13Fij,
				   ROUND(SUM(b14_liq), 0) + @nB14Fij,
				   ROUND(SUM(b15_liq), 0) + @nB15Fij,
				   ROUND(SUM(b16_liq), 0) + @nB16Fij,
				   ROUND(SUM(b17_liq), 0) + @nB17Fij,
				   ROUND(SUM(b18_liq), 0) + @nB18Fij,
				   ROUND(SUM(b19_liq), 0) + @nB19Fij,
				   ROUND(SUM(b20_liq), 0) + @nB20Fij,
				   @nCodCont,
				   @Cons_AnoAnt,
				   @Cons_MesAnt,
				   @Cons_PagosAnt,
				   @Cons_PagosMes,
				   @ValProvMes + @nValDife
			 FROM #T_BasesCol;
		  END;
			 ELSE
		  BEGIN
			 IF @dias_Pen = 0
			 BEGIN
				INSERT INTO Rhh_ConsVaca( cod_emp,
									 cod_con,
									 cod_cia,
									 cod_suc,
									 cod_cco,
									 cod_cl1,
									 cod_cl2,
									 cod_cl3,
									 cod_cl4,
									 cod_cl5,
									 cod_cl6,
									 cod_cl7,
									 fec_liq,
									 tip_liq,
									 fec_ing,
									 fec_Ini_Cau,
									 fec_fin_cau,
									 Dia_cau,
									 Dia_per_cau,
									 val_vac,
									 sal_bas,
									 sal_prom,
									 val_acu,
									 dia_per_acum,
									 val_provi,
									 val_dife,
									 fec_cte,
									 val_vacPag,
									 Dia_tot_vac,
									 b01_liq,
									 b02_liq,
									 b03_liq,
									 b04_liq,
									 b05_liq,
									 b06_liq,
									 b07_liq,
									 b08_liq,
									 b09_liq,
									 b10_liq,
									 b11_liq,
									 b12_liq,
									 b13_liq,
									 b14_liq,
									 b15_liq,
									 b16_liq,
									 b17_liq,
									 b18_liq,
									 b19_liq,
									 b20_liq,
									 cod_cont,
									 Cons_AnoAnt,
									 Cons_MesAnt,
									 Cons_PagosAnt,
									 Cons_PagosMes,
									 ValProvMes
								    )
				VALUES
					  (
					  @cCod_emp, @cConcepto, @cCod_Cia, @cCod_Suc, @cCod_Cco, @cCod_Cl1, @cCod_Cl2, @cCod_Cl3, @cCod_Cl4, @cCod_Cl5, @cCod_Cl6,
					  @cCod_Cl7, @fFec_liq, @cTip_liq, @fec_ing, @fec_ing, @fFec_cte, @nDiaCau, @dias_Pen, @nValVac, @nSalBas, @nBase, @nBase,
					  @nDiaPerAcum, @nValProvis + @nValAjusAnte, @nValDife, @fFec_cte, @nValPag, ISNULL(@nDiaPerCau, 0), 0, 0, 0, 0, 0, 0, 0, 0,
					  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, @nCodCont, @Cons_AnoAnt, @Cons_MesAnt, @Cons_PagosAnt, @Cons_PagosMes, @ValProvMes +
					  @nValDife );
			 END;

		  END;

		  SET @nValProvis = @nValProvis + @nValAjusAnte;

		  IF @cTip_liq <> '04'
		  BEGIN
			 IF @nValProvis = 0
			 BEGIN
				SET @nDiaCau = 0;
			 END;

			 IF @nValVac = 0
			 BEGIN
				SET @DiaVacPag = 0;
			 END;

			 /*Inserta Registro del consolidado*/
			 EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cConcepto,
							    @Cantidad = @dias_Pen,
							    @Resultado = @nValVac,
							    @Ya_Insert = 1;

			 /*Inserta Registro de la Provisión Acumulada*/
			 EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cCodConProvAcu,
							    @Cantidad = @nDiaCau,
							    @Resultado = @nValProvis,
							    @Ya_Insert = 1;

			 /*Inserta Registro Vacaciones Pagadas*/
			 EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cCodConVacPag,
							    @Cantidad = @DiaVacPag,
							    @Resultado = @nValPag,
							    @Ya_Insert = 1;
		  END;

		  IF @nValDife <> 0
		  BEGIN
			 /*Inserta Registro del Ajuste*/
			 EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cCodConAju,
							    @Cantidad = @nDiaCau,
							    @Resultado = @nValDife,
							    @Ya_Insert = 1;
		  END;
	   END;
    END;
	
    SET @nValor = ROUND(@nValor, 0);
    SET @nCantidad = (@nHabDis + @nNhadis);

    IF @nIndConsolidado = 0
    BEGIN
	   EXEC dbo.Sp_rhh_LiqCte @cCodCon = @cConcepto,
						 @Cantidad = @nCantidad,
						 @Resultado = @nValor;
    END;

    IF @cConcepto = '001130' AND (@nHabDis + @nNhadis) <> 0
    BEGIN
	   SET @nCantidad = @nHabDis + @nNhadis;

	   IF @nIndDesc31 = 1
	   BEGIN
		  IF DATEPART(DAY, EOMONTH(@fec_sal)) = '31'
		  BEGIN
			 IF @ind_sab = 0
			 BEGIN
				SET @nCantidad = @nCantidad - @nIndDesc31;
			 END;    		/*2013-0995*/
		  END;
	   END;

	   /*** Inserta Días habiles , Días No Hábiles en la tabla de liquidación SRS-2012-0909***/

	   /*2013-0716*/
	   IF @nCantidad > 0
	   BEGIN
		  SET @val_diahab = ROUND((@nValor / @nCantidad) * @nHabDis, 0);
	   END;

	   SET @val_dianhab = @nValor - @val_diahab;

	   EXEC dbo.Sp_rhh_LiqCte @cCodCon = '000050',
						 @Cantidad = @nHabDis,
						 @Resultado = @val_diahab,
						 @ya_insert = 1;

	   EXEC dbo.Sp_rhh_LiqCte @cCodCon = '000051',
						 @Cantidad = @nNhadis,
						 @Resultado = @val_dianhab,
						 @ya_insert = 1;
    END;
END;
```
