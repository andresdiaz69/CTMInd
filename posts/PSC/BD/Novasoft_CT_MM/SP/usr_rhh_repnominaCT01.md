# Stored Procedure: usr_rhh_repnominaCT01

## Usa los objetos:
- [[Rhh_AsocCptos]]
- [[Rhh_AsocCptosDet]]
- [[rhh_liqhis]]
- [[rhh_liqmes]]

```sql


-- =============================================
-- Author:		<ADRIANA CUEVAS>
-- Create date: <21 NOVIEMBRE 2019>
-- Description:	<INFORME COMPARATIVO DE NOMINA>

-- exec usr_rhh_repnominaCT01 '20190515', '%','%','%','%','%','%','%','%','01', 'H'
-- exec usr_rhh_repnominaCT01 '20190215', '%','%','%','%','%','%','%','%','01', 'P'
-- =============================================
CREATE PROCEDURE [dbo].[usr_rhh_repnominaCT01]
	@FEC_CTE DATETIME,
	@COD_CIA CHAR(2)='%',
	@COD_SUC CHAR(3)='%',
	@COD_CCO CHAR(10)='%',
	@COD_CLAS1 VARCHAR(12)='%',
	@COD_CLAS2 VARCHAR(12)='%',
	@COD_CLAS3 VARCHAR(12)='%',
	@COD_CLAS4 VARCHAR(12)='%',
	@COD_CLAS5 VARCHAR(12)='%',
	@TIP_LIQ CHAR(2)='%',
	@ORIGEN CHAR(1)='H'

AS
BEGIN
	-- SET NOCOUNT ON added to prevent extra result sets from
	-- interfering with SELECT statements.
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;

DECLARE @FECCTEANT1 DATETIME
DECLARE @FECCTEANT2 DATETIME 
DECLARE @DIA INT

SELECT @FECCTEANT1=(SELECT DATEADD(MM, -1,(@fec_cte)))
SELECT @FECCTEANT2=(SELECT DATEADD(MM, -2,(@fec_cte)))

SET @DIA=(SELECT datepart(day,(@FEC_CTE)))

IF @DIA>15
BEGIN
SET @FECCTEANT1=(SELECT EOMONTH(@FECCTEANT1))
SET @FECCTEANT2=(SELECT EOMONTH(@FECCTEANT2))
END


DECLARE @TOTAL MONEY
DECLARE @TOTAL1 MONEY
DECLARE @TOTAL2 MONEY

CREATE TABLE #CONCEPTOS
(
ID INT,
DESCRIPCION VARCHAR(400) COLLATE DATABASE_DEFAULT,
CONCEPTO CHAR(6) COLLATE DATABASE_DEFAULT,
MODO CHAR(2) COLLATE DATABASE_DEFAULT,
NATURALEZA CHAR(2) COLLATE DATABASE_DEFAULT
)
CREATE TABLE #NOMINA 
(
 COD_CIA CHAR(2) COLLATE DATABASE_DEFAULT,
 COD_CON VARCHAR(6) COLLATE DATABASE_DEFAULT,
 VAL_LIQ MONEY ,
 GRUPO CHAR(12) COLLATE DATABASE_DEFAULT,
 DESCRIPCION CHAR(50) COLLATE DATABASE_DEFAULT,
 ID INT,
 FECHA DATETIME,
 VAL_LIQ1 MONEY,
 VAL_LIQ2 MONEY,
 FECHA1 DATETIME,
 FECHA2 DATETIME,
 PERIODO INT,
 TOTAL MONEY,
 TOTAL1 MONEY,
 TOTAL2 MONEY 
)

INSERT INTO #CONCEPTOS 
SELECT C.Ide_AsocIntCpto, Des_AsocIntCpto, cod_con, mod_liq, '1' FROM Rhh_AsocCptos C WITH (NOLOCK)
INNER JOIN Rhh_AsocCptosDet CD ON CD.Ide_AsocIntCpto=C.Ide_AsocIntCpto
WHERE C.Ide_AsocIntCpto BETWEEN 100 AND 199
UNION ALL
SELECT C.Ide_AsocIntCpto, Des_AsocIntCpto, cod_con, mod_liq, '2' FROM Rhh_AsocCptos C WITH (NOLOCK)
INNER JOIN Rhh_AsocCptosDet CD ON CD.Ide_AsocIntCpto=C.Ide_AsocIntCpto
WHERE C.Ide_AsocIntCpto BETWEEN 200 AND 299


DECLARE @NOMINA TABLE
(
 COD_CIA CHAR(2),
 COD_CON VARCHAR(6),
 VAL_LIQ MONEY,
 GRUPO CHAR(12),
 DESCRIPCION CHAR(50),
 ID INT,
 FECHA DATETIME 
)

DECLARE @NOMINAANT1 TABLE
(
 COD_CIA CHAR(2),
 COD_CON1 VARCHAR(6),
 VAL_LIQ1 MONEY,
 GRUPO1 CHAR(12),
 DESCRIPCION1 CHAR(50),
 ID INT,
 FECHA DATETIME
)

DECLARE @NOMINAANT2 TABLE
(
 COD_CIA CHAR(2),
 COD_CON2 VARCHAR(6),
 VAL_LIQ2 MONEY,
 GRUPO2 CHAR(12),
 DESCRIPCION2 CHAR(50),
 ID INT,
 FECHA DATETIME
)

	IF @ORIGEN='H'
		BEGIN
		INSERT INTO @NOMINA
		SELECT DISTINCT h.cod_cia,h.cod_con, sum(val_liq),
		NATURALEZA AS GRUPO, 
		C.DESCRIPCION, C.ID, FEC_CTE
		FROM rhh_liqhis H WITH (NOLOCK)
		INNER JOIN #CONCEPTOS C ON C.CONCEPTO=H.COD_CON AND C.MODO=H.mod_liq
		WHERE fec_cte=@FEC_CTE--@fec_cte
		AND H.COD_CIA LIKE RTRIM(@COD_CIA)
		AND H.COD_SUC LIKE RTRIM(@COD_SUC)
		AND H.COD_CCO LIKE RTRIM(@COD_CCO) 
		AND H.COD_CL1 LIKE RTRIM(@COD_CLAS1)
		AND H.COD_CL2 LIKE RTRIM(@COD_CLAS2)
		AND H.COD_CL3 LIKE RTRIM(@COD_CLAS3)
		AND H.COD_CL4 LIKE RTRIM(@COD_CLAS4)
		AND H.COD_CL5 LIKE RTRIM(@COD_CLAS5)
		AND H.TIP_LIQ LIKE RTRIM(@TIP_LIQ) 
		GROUP BY h.cod_cia, h.cod_con, NATURALEZA, DESCRIPCION, C.ID, FEC_CTE


		INSERT INTO @NOMINAANT1
		SELECT DISTINCT h.cod_cia,h.cod_con, sum(val_liq),
		NATURALEZA AS GRUPO,
		C.DESCRIPCION, C.ID,FEC_CTE
		FROM rhh_liqhis H WITH (NOLOCK)
		INNER JOIN #CONCEPTOS C ON C.CONCEPTO=H.COD_CON AND C.MODO=H.mod_liq
		WHERE fec_cte=@FECCTEANT1
		AND H.COD_CIA LIKE RTRIM(@COD_CIA)
		AND H.COD_SUC LIKE RTRIM(@COD_SUC)
		AND H.COD_CCO LIKE RTRIM(@COD_CCO) 
		AND H.COD_CL1 LIKE RTRIM(@COD_CLAS1)
		AND H.COD_CL2 LIKE RTRIM(@COD_CLAS2)
		AND H.COD_CL3 LIKE RTRIM(@COD_CLAS3)
		AND H.COD_CL4 LIKE RTRIM(@COD_CLAS4)
		AND H.COD_CL5 LIKE RTRIM(@COD_CLAS5)
		AND H.TIP_LIQ LIKE RTRIM(@TIP_LIQ) 
		GROUP BY h.cod_cia, h.cod_con, NATURALEZA, DESCRIPCION , C.ID, FEC_CTE


		INSERT INTO @NOMINAANT2
		SELECT DISTINCT h.cod_cia,h.cod_con, sum(val_liq), 
		NATURALEZA AS GRUPO, 
		C.DESCRIPCION, C.ID,FEC_CTE
		FROM rhh_liqhis H WITH (NOLOCK)
		INNER JOIN #CONCEPTOS C ON C.CONCEPTO=H.COD_CON AND C.MODO=H.mod_liq
		WHERE FEC_CTE=@FECCTEANT2
		AND H.COD_CIA LIKE RTRIM(@COD_CIA)
		AND H.COD_SUC LIKE RTRIM(@COD_SUC)
		AND H.COD_CCO LIKE RTRIM(@COD_CCO) 
		AND H.COD_CL1 LIKE RTRIM(@COD_CLAS1)
		AND H.COD_CL2 LIKE RTRIM(@COD_CLAS2)
		AND H.COD_CL3 LIKE RTRIM(@COD_CLAS3)
		AND H.COD_CL4 LIKE RTRIM(@COD_CLAS4)
		AND H.COD_CL5 LIKE RTRIM(@COD_CLAS5)
		AND H.TIP_LIQ LIKE RTRIM(@TIP_LIQ) 
		GROUP BY h.cod_cia, h.cod_con, NATURALEZA, DESCRIPCION, C.ID, FEC_CTE

		INSERT INTO  #NOMINA (ID, COD_CON , VAL_LIQ, GRUPO, DESCRIPCION, FECHA, PERIODO)
		SELECT N.ID, COD_CON,  ISNULL(VAL_LIQ,0) AS VAL_LIQ, GRUPO, DESCRIPCION,FECHA, PERIODO=1 
		FROM @NOMINA N
		UNION ALL
		SELECT ID, COD_CON1,  ISNULL(VAL_LIQ1,0) AS VAL_LIQ1, GRUPO1, DESCRIPCION1, FECHA,PERIODO=2
		FROM @NOMINAANT1 N
		UNION ALL
		SELECT ID, COD_CON2,  ISNULL(VAL_LIQ2,0) AS VAL_LIQ2, GRUPO2, DESCRIPCION2,FECHA,PERIODO=3 
		FROM @NOMINAANT2 N

		SELECT @TOTAL=((SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=1 AND PERIODO=1)-(SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=2 AND PERIODO=1))
		SELECT @TOTAL1=((SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=1 AND PERIODO=2)-(SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=2 AND PERIODO=2))
		SELECT @TOTAL2=((SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=1 AND PERIODO=3)-(SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=2 AND PERIODO=3))

		SELECT ID,COD_CON,GRUPO, DESCRIPCION,PERIODO,	
		CASE PERIODO
						WHEN 1 THEN VAL_LIQ
						END  VAL_LIQ,
		CASE PERIODO
						WHEN 2 THEN VAL_LIQ
						END VAL_LIQ1,
		CASE PERIODO
						WHEN 3 THEN VAL_LIQ
						END VAL_LIQ2,
		FECHA=@FEC_CTE, FECHA1=@FECCTEANT1, FECHA2=@FECCTEANT2, TOTAL=@TOTAL, TOTAL1=@TOTAL1, TOTAL2=@TOTAL2
		FROM #NOMINA

		
END

	IF @ORIGEN='P'
		BEGIN
			INSERT INTO @NOMINA
			SELECT DISTINCT M.cod_cia,M.cod_con, sum(val_liq), --cp.Des_AsocIntCpto AS DESCRIPCION,
			NATURALEZA AS GRUPO,
			C.DESCRIPCION,C.ID,FEC_CTE
			FROM rhh_liqmes M WITH (NOLOCK)
			INNER JOIN #CONCEPTOS C ON C.CONCEPTO=M.COD_CON AND C.MODO=M.mod_liq
			WHERE fec_cte=@FEC_CTE
			AND M.COD_CIA LIKE RTRIM(@COD_CIA)
			AND M.COD_SUC LIKE RTRIM(@COD_SUC)
			AND M.COD_CCO LIKE RTRIM(@COD_CCO) 
			AND M.COD_CL1 LIKE RTRIM(@COD_CLAS1)
			AND M.COD_CL2 LIKE RTRIM(@COD_CLAS2)
			AND M.COD_CL3 LIKE RTRIM(@COD_CLAS3)
			AND M.COD_CL4 LIKE RTRIM(@COD_CLAS4)
			AND M.COD_CL5 LIKE RTRIM(@COD_CLAS5)
			AND M.TIP_LIQ LIKE RTRIM(@TIP_LIQ) 
			GROUP BY M.cod_cia, M.cod_con, NATURALEZA, DESCRIPCION, C.ID, FEC_CTE


			INSERT INTO @NOMINAANT1
				SELECT DISTINCT h.cod_cia,h.cod_con, sum(val_liq),
				NATURALEZA AS GRUPO,
				C.DESCRIPCION, C.ID,FEC_CTE
				FROM rhh_liqhis H WITH (NOLOCK)
				INNER JOIN #CONCEPTOS C ON C.CONCEPTO=H.COD_CON AND C.MODO=H.mod_liq
				WHERE fec_cte=@FECCTEANT1
				AND H.COD_CIA LIKE RTRIM(@COD_CIA)
				AND H.COD_SUC LIKE RTRIM(@COD_SUC)
				AND H.COD_CCO LIKE RTRIM(@COD_CCO) 
				AND H.COD_CL1 LIKE RTRIM(@COD_CLAS1)
				AND H.COD_CL2 LIKE RTRIM(@COD_CLAS2)
				AND H.COD_CL3 LIKE RTRIM(@COD_CLAS3)
				AND H.COD_CL4 LIKE RTRIM(@COD_CLAS4)
				AND H.COD_CL5 LIKE RTRIM(@COD_CLAS5)
				AND H.TIP_LIQ LIKE RTRIM(@TIP_LIQ) 
				GROUP BY h.cod_cia, h.cod_con, NATURALEZA, DESCRIPCION , C.ID, FEC_CTE

				INSERT INTO @NOMINAANT2
				SELECT DISTINCT h.cod_cia,h.cod_con, sum(val_liq), 
				NATURALEZA AS GRUPO, 
				C.DESCRIPCION, C.ID,FEC_CTE
				FROM rhh_liqhis H WITH (NOLOCK)
				INNER JOIN #CONCEPTOS C ON C.CONCEPTO=H.COD_CON AND C.MODO=H.mod_liq
				WHERE FEC_CTE=@FECCTEANT2
				AND H.COD_CIA LIKE RTRIM(@COD_CIA)
				AND H.COD_SUC LIKE RTRIM(@COD_SUC)
				AND H.COD_CCO LIKE RTRIM(@COD_CCO) 
				AND H.COD_CL1 LIKE RTRIM(@COD_CLAS1)
				AND H.COD_CL2 LIKE RTRIM(@COD_CLAS2)
				AND H.COD_CL3 LIKE RTRIM(@COD_CLAS3)
				AND H.COD_CL4 LIKE RTRIM(@COD_CLAS4)
				AND H.COD_CL5 LIKE RTRIM(@COD_CLAS5)
				AND H.TIP_LIQ LIKE RTRIM(@TIP_LIQ) 
				GROUP BY h.cod_cia, h.cod_con, NATURALEZA, DESCRIPCION, C.ID, FEC_CTE
				
				INSERT INTO  #NOMINA (ID, COD_CON , VAL_LIQ, GRUPO, DESCRIPCION, FECHA, PERIODO)
				SELECT N.ID, COD_CON,  ISNULL(VAL_LIQ,0) AS VAL_LIQ, GRUPO, DESCRIPCION,FECHA, PERIODO=1 
				FROM @NOMINA N
				UNION ALL
				SELECT ID, COD_CON1,  ISNULL(VAL_LIQ1,0) AS VAL_LIQ1, GRUPO1, DESCRIPCION1, FECHA,PERIODO=2
				FROM @NOMINAANT1 N
				UNION ALL
				SELECT ID, COD_CON2,  ISNULL(VAL_LIQ2,0) AS VAL_LIQ2, GRUPO2, DESCRIPCION2,FECHA,PERIODO=3 
				FROM @NOMINAANT2 N
				
				SELECT @TOTAL=((SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=1 AND PERIODO=1)-(SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=2 AND PERIODO=1))
				SELECT @TOTAL1=((SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=1 AND PERIODO=2)-(SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=2 AND PERIODO=2))
				SELECT @TOTAL2=((SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=1 AND PERIODO=3)-(SELECT SUM(VAL_LIQ) FROM #NOMINA WHERE GRUPO=2 AND PERIODO=3))

				SELECT ID,COD_CON,GRUPO, DESCRIPCION,PERIODO,	
				CASE PERIODO
								WHEN 1 THEN VAL_LIQ
								END  VAL_LIQ,
				CASE PERIODO
								WHEN 2 THEN VAL_LIQ
								END VAL_LIQ1,
				CASE PERIODO
								WHEN 3 THEN VAL_LIQ
								END VAL_LIQ2,
				FECHA=@FEC_CTE, FECHA1=@FECCTEANT1, FECHA2=@FECCTEANT2, TOTAL=@TOTAL, TOTAL1=@TOTAL1, TOTAL2=@TOTAL2
				FROM #NOMINA
		END

END

```
